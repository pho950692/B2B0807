{% extends "base.html" %}

{% block title %}Email發票下載中心 - fastB2B{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto bg-white rounded-2xl shadow-xl p-10 mt-10 animate__animated animate__fadeIn">
  {% if user_email is defined and not user_email %}
  <div class="bg-red-100 border-l-4 border-red-500 p-4 rounded-xl mb-6 shadow flex items-center gap-3 animate__animated animate__fadeIn">
    <i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
    <span class="text-red-800 text-lg font-semibold">尚未設定公司 Email，請至 <a href="/account_edit" class="underline text-blue-700 hover:text-blue-900">帳號設定</a> 補齊 Email，否則無法自動接收合作公司發票通知！</span>
  </div>
  {% endif %}
  <!-- 新發票數量提示區塊 -->
  <div id="newInvoiceCountAlert" class="hidden bg-yellow-100 border-l-4 border-yellow-500 p-4 rounded-xl mb-6 shadow flex items-center gap-3 animate__animated animate__fadeIn">
    <i class="fas fa-envelope-open-text text-yellow-600 text-2xl"></i>
    <span class="text-yellow-800 text-lg font-semibold" id="newInvoiceCountMsg">有新 Email 發票待下載！</span>
    <a href="/preferences" class="ml-4 px-4 py-2 bg-blue-600 text-white rounded shadow hover:bg-blue-700 transition">前往下載</a>
  </div>
  <h2 class="text-4xl font-extrabold text-yellow-700 mb-6 flex items-center justify-center drop-shadow">
    <i class="fas fa-envelope-open-text mr-3"></i> Email發票下載中心
  </h2>
  <p class="text-lg text-gray-700 mb-8 text-center font-semibold">集中管理所有自動下載的 Email 發票圖片，支援單張/批次下載與刪除。</p>
  <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded mb-8">
    <ul class="list-disc pl-6 text-yellow-700 text-base space-y-1">
      <li>僅顯示合作公司 Email 來的發票附件。</li>
      <li>可多選下載或刪除，操作更方便。</li>
      <li>如需辨識，請至自動辨識頁載入。</li>
    </ul>
  </div>
  <div class="mb-4 flex flex-wrap gap-3 items-center">
    <span class="font-semibold text-gray-700">依時間篩選：</span>
    <select id="dateRangeSelect" class="border rounded px-2 py-1">
      <option value="">請選擇</option>
      <option value="1">一天內</option>
      <option value="7">一周內</option>
      <option value="30">一個月內</option>
      <option value="365">一年內</option>
      <option value="all">全部</option>
    </select>
    <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1 rounded shadow ml-2" onclick="queryByDateRange()">查詢</button>
    <button id="btnDownloadAll" class="bg-green-600 hover:bg-green-700 text-white px-4 py-1 rounded shadow ml-4 hidden" onclick="downloadAllFiltered()">全部下載</button>
  </div>
  <div id="emailFileTableWrap" class="overflow-x-auto hidden">
    <table class="w-full border border-gray-300 text-center text-base rounded-xl shadow-lg overflow-hidden" id="emailFileTable">
      <thead class="bg-yellow-100">
        <tr>
          <th class="border px-4 py-3"><input type="checkbox" id="selectAll"></th>
          <th class="border px-4 py-3">檔案名稱</th>
          <th class="border px-4 py-3">下載</th>
          <th class="border px-4 py-3">刪除</th>
        </tr>
      </thead>
      <tbody id="emailFileTableBody"></tbody>
    </table>
  </div>
  <div class="overflow-x-auto">
    <table class="w-full border border-gray-300 text-center text-base rounded-xl shadow-lg overflow-hidden" id="emailFileTable">
      <thead class="bg-yellow-100">
        <tr>
          <th class="border px-4 py-3"><input type="checkbox" id="selectAll"></th>
          <th class="border px-4 py-3">檔案名稱</th>
          <th class="border px-4 py-3">下載</th>
          <th class="border px-4 py-3">刪除</th>
        </tr>
      </thead>
      <tbody id="emailFileTableBody"></tbody>
    </table>
  </div>
  <div class="flex gap-3 mt-6 justify-end">
    <button id="btnRefresh" class="bg-blue-500 hover:bg-blue-700 text-white px-5 py-2 rounded shadow">重新整理</button>
    <button id="btnDownloadSelected" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded shadow">下載選取</button>
    <button id="btnDeleteSelected" class="bg-red-500 hover:bg-red-600 text-white px-5 py-2 rounded shadow">刪除選取</button>
  </div>
</div>
<script>
let lastFilteredFiles = [];
function queryByDateRange() {
  const sel = document.getElementById('dateRangeSelect');
  const val = sel.value;
  if (!val) {
    document.getElementById('emailFileTableWrap').classList.add('hidden');
    document.getElementById('btnDownloadAll').classList.add('hidden');
    return;
  }
  if (val === 'all') {
    fetchEmailFiles();
  } else {
    fetchEmailFilesByDays(val);
  }
}
async function fetchEmailFiles() {
  const r = await fetch('/api/new_invoices');
  const data = await r.json();
  const files = data.files || [];
  lastFilteredFiles = files;
  renderEmailFileTable(files);
}
async function fetchEmailFilesByDays(days) {
  const r = await fetch(`/api/invoices_by_date_range?days=${days}`);
  const data = await r.json();
  const files = data.files || [];
  lastFilteredFiles = files;
  renderEmailFileTable(files);
}
function renderEmailFileTable(files) {
  const wrap = document.getElementById('emailFileTableWrap');
  const btnAll = document.getElementById('btnDownloadAll');
  const tbody = document.getElementById('emailFileTableBody');
  if (files.length === 0) {
    wrap.classList.add('hidden');
    btnAll.classList.add('hidden');
    return;
  }
  wrap.classList.remove('hidden');
  btnAll.classList.remove('hidden');
  tbody.innerHTML = '';
  files.forEach(f => {
    tbody.innerHTML += `
      <tr>
        <td class="border px-4 py-2"><input type="checkbox" class="fileCheckbox" value="${f}"></td>
        <td class="border px-4 py-2">${f}</td>
        <td class="border px-4 py-2"><a href="/uploads/${f}" download class="text-blue-600 hover:underline">下載</a></td>
        <td class="border px-4 py-2"><button class="bg-red-400 hover:bg-red-500 text-white px-3 py-1 rounded deleteBtn" data-fname="${f}">刪除</button></td>
      </tr>`;
  });
}
function downloadAllFiltered() {
  lastFilteredFiles.forEach(f => {
    const link = document.createElement('a');
    link.href = '/uploads/' + f;
    link.download = f;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  });
}
document.getElementById('btnRefresh').onclick = fetchEmailFiles;
document.getElementById('selectAll').onclick = function() {
  document.querySelectorAll('.fileCheckbox').forEach(cb => cb.checked = this.checked);
};
document.getElementById('btnDownloadSelected').onclick = function() {
  document.querySelectorAll('.fileCheckbox:checked').forEach(cb => {
    const link = document.createElement('a');
    link.href = '/uploads/' + cb.value;
    link.download = cb.value;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  });
};
document.getElementById('btnDeleteSelected').onclick = async function() {
  const files = Array.from(document.querySelectorAll('.fileCheckbox:checked')).map(cb => cb.value);
  if (!files.length) return alert('請先勾選要刪除的檔案');
  if (!confirm('確定要刪除選取的檔案嗎？')) return;
  for (const fname of files) {
    await fetch('/api/delete_invoice_file', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ filename: fname }) });
  }
  fetchEmailFiles();
};
document.getElementById('emailFileTableBody').onclick = async function(e) {
  if (e.target.classList.contains('deleteBtn')) {
    const fname = e.target.getAttribute('data-fname');
    if (!confirm('確定要刪除 ' + fname + ' 嗎？')) return;
    await fetch('/api/delete_invoice_file', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ filename: fname }) });
    fetchEmailFiles();
  }
};
fetchEmailFiles();
// 新發票數量提示自動查詢
async function checkNewInvoiceCount() {
  try {
    const rsp = await fetch('/api/new_invoices');
    const data = await rsp.json();
    const alertBox = document.getElementById('newInvoiceCountAlert');
    if (data.count > 0) {
      alertBox.classList.remove('hidden');
      document.getElementById('newInvoiceCountMsg').textContent = `有 ${data.count} 張新 Email 發票待處理！`;
    } else {
      alertBox.classList.add('hidden');
    }
  } catch (e) {}
}
checkNewInvoiceCount();
setInterval(checkNewInvoiceCount, 60000); // 每分鐘自動查詢
</script>
{% endblock %}

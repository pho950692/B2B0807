{% extends "base.html" %}

{% block title %}ç™¼ç¥¨æŸ¥è©¢èˆ‡ç®¡ç†{% endblock %}

{% block head_extra %}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css" />
  <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/bundle.js"></script>
  <style>
    /* æ¼¸å±¤èƒŒæ™¯ */
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    /* å¡ç‰‡æ¨£å¼ */
    .card {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    }
    
    /* æŸ¥è©¢è¡¨å–®å„ªåŒ– */
    .search-form {
      background: linear-gradient(145deg, #f8fafc, #e2e8f0);
      border: 1px solid #e2e8f0;
      border-radius: 1rem;
      padding: 2rem;
      margin-bottom: 2rem;
    }
    
    /* è¼¸å…¥æ¡†æ¨£å¼ */
    .input-enhanced {
      transition: all 0.3s ease;
      border: 2px solid #e2e8f0;
    }
    .input-enhanced:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
      transform: scale(1.02);
      outline: none;
    }
    
    /* ç…§ç‰‡æŸ¥è©¢å€å¡Š */
    .photo-search { 
      display: flex; 
      align-items: center; 
      gap: 0.75rem; 
      flex-wrap: wrap; 
      margin: 0 0 1.5rem 0;
      padding: 1.5rem;
      background: linear-gradient(145deg, #fef7ff, #f3e8ff);
      border: 2px dashed #a855f7;
      border-radius: 1rem;
      transition: all 0.3s ease;
    }
    .photo-search:hover {
      border-color: #7c3aed;
      background: linear-gradient(145deg, #faf5ff, #ede9fe);
    }

    /* æŒ‰éˆ•æ¨£å¼ */
    .btn { 
      border: 1px solid #1e40af; 
      background: linear-gradient(145deg, #3b82f6, #1d4ed8); 
      color: #fff; 
      padding: 0.75rem 1.5rem; 
      border-radius: 0.75rem; 
      font-weight: 600; 
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
    }
    .btn:hover { 
      background: linear-gradient(145deg, #1d4ed8, #1e3a8a);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
    }
    .btn-outline { 
      background: linear-gradient(145deg, #ffffff, #f8fafc); 
      color: #1d4ed8; 
      border-color: #3b82f6;
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2);
    }
    .btn-outline:hover { 
      background: linear-gradient(145deg, #eff6ff, #dbeafe);
      transform: translateY(-2px);
    }

    /* æª”åæ¨™ç±¤ */
    .chip { 
      font-size: 0.9rem; 
      padding: 0.5rem 1rem; 
      border: 1px solid #d1d5db; 
      border-radius: 2rem; 
      background: linear-gradient(145deg, #f9fafb, #f3f4f6); 
      color: #374151;
      transition: all 0.3s ease;
    }

    /* å¿«é€Ÿé¸æ“‡æŒ‰éˆ• */
    .quick {
      transition: all 0.3s ease;
      border: 1px solid #d1d5db;
      background: linear-gradient(145deg, #ffffff, #f8fafc);
    }
    .quick:hover {
      border-color: #3b82f6;
      background: linear-gradient(145deg, #eff6ff, #dbeafe);
      transform: scale(1.05);
    }

    /* è¡¨æ ¼æ¨£å¼ */
    .table-container {
      background: white;
      border-radius: 1rem;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }
    
    .enhanced-table {
      border-collapse: separate;
      border-spacing: 0;
    }
    .enhanced-table th {
      background: linear-gradient(145deg, #1f2937, #374151);
      color: white;
      font-weight: 600;
      text-align: center;
      padding: 1rem;
      border: none;
    }
    .enhanced-table td {
      padding: 1rem;
      border-bottom: 1px solid #e5e7eb;
      transition: background-color 0.3s ease;
    }
    .enhanced-table tr:hover td {
      background-color: #f0f9ff;
    }

    /* åœ–ç‰‡é è¦½æ¨¡æ…‹æ¡† */
    .modal { position: fixed; inset: 0; display: none; z-index: 60; }
    .modal.show { display: block; }
    .modal .backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); }
    .modal .dialog { 
      position: relative; 
      z-index: 1; 
      max-width: min(92vw, 1100px); 
      margin: 6vh auto; 
      background: #111827; 
      padding: 0; 
      border-radius: 1rem; 
      box-shadow: 0 25px 50px rgba(0,0,0,0.5);
      overflow: hidden;
    }
    .modal header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      padding: 1rem 1.5rem; 
      color: #fff; 
      background: linear-gradient(145deg, #1f2937, #374151);
      font-weight: 600;
    }
    .modal .close { 
      appearance: none; 
      border: none; 
      background: transparent; 
      color: #9ca3af; 
      font-size: 1.8rem; 
      cursor: pointer; 
      padding: 0.5rem; 
      line-height: 1;
      border-radius: 0.5rem;
      transition: all 0.3s ease;
    }
    .modal .close:hover { 
      color: #fff; 
      background: rgba(255, 255, 255, 0.1);
    }
    .modal .body { background: #000; }
    .modal .body img { display: block; max-width: 100%; height: auto; margin: 0 auto; }

    /* åŠŸèƒ½èªªæ˜å€å¡Š */
    .feature-info {
      background: linear-gradient(145deg, #f0f9ff, #e0f2fe);
      border: 1px solid #0284c7;
      border-radius: 1rem;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }
    
    /* çµ±è¨ˆå¡ç‰‡ */
    .stat-card {
      background: linear-gradient(145deg, #ffffff, #f8fafc);
      border: 1px solid #e2e8f0;
      border-radius: 1rem;
      padding: 1.5rem;
      text-align: center;
      transition: all 0.3s ease;
    }
    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }
  </style>
{% endblock %}

{% block content %}
<!-- é é¢æ¨™é¡Œå€ -->
<div class="gradient-bg text-white py-12 mb-8">
  <div class="max-w-7xl mx-auto px-6">
    <div class="text-center">
      <h1 class="text-4xl md:text-5xl font-extrabold mb-4 flex items-center justify-center drop-shadow">
        <i class="fas fa-search-dollar mr-4 text-3xl"></i> ç™¼ç¥¨æŸ¥è©¢èˆ‡ç®¡ç†
      </h1>
      <p class="text-xl md:text-2xl text-blue-100 mb-6">è¼•é¬†æŸ¥è©¢ã€ç®¡ç†èˆ‡åˆ†ææ‚¨çš„ç™¼ç¥¨è¨˜éŒ„</p>
      <!-- æŸ¥è©¢/å®‰å…¨/æµç¨‹èªªæ˜è‰²å¡Š -->
      <div class="bg-blue-100 border-l-4 border-blue-400 p-4 rounded-xl mb-8 shadow flex items-center gap-3 animate__animated animate__fadeIn">
        <i class="fas fa-info-circle text-blue-500 text-2xl"></i>
        <span class="text-blue-700 text-lg font-semibold">æŸ¥è©¢å‰è«‹ç¢ºèªï¼š1. æ—¥æœŸ/å» å•†/æ¢ä»¶æ­£ç¢º 2. åŒ¯å‡ºè³‡æ–™åƒ…é™æˆæ¬Šäººå“¡ 3. åœ–ç‰‡æŸ¥è©¢è«‹ä¸Šå‚³æ¸…æ™°ç™¼ç¥¨ç…§ 4. è‹¥æŸ¥ç„¡çµæœå¯æ”¾å¯¬æ¢ä»¶æˆ–è¯çµ¡ç®¡ç†å“¡</span>
      </div>
      <div class="flex flex-wrap justify-center gap-4 text-sm md:text-base">
        <span class="bg-white bg-opacity-20 px-4 py-2 rounded-full">ğŸ” æ™ºèƒ½æœå°‹</span>
        <span class="bg-white bg-opacity-20 px-4 py-2 rounded-full">ğŸ“± åœ–ç‰‡æŸ¥è©¢</span>
        <span class="bg-white bg-opacity-20 px-4 py-2 rounded-full">ğŸ“Š æ•¸æ“šå°å‡º</span>
        <span class="bg-white bg-opacity-20 px-4 py-2 rounded-full">ğŸ“ˆ çµ±è¨ˆåˆ†æ</span>
      </div>
    </div>
  </div>
</div>

<div class="max-w-7xl mx-auto px-6 pb-12">
  <!-- åŠŸèƒ½èªªæ˜å€å¡Š -->
  <div class="feature-info mb-8">
    <div class="flex items-start gap-4">
      <div class="text-3xl">ğŸ’¡</div>
      <div>
        <h3 class="text-xl font-bold text-gray-800 mb-2">æŸ¥è©¢åŠŸèƒ½èªªæ˜</h3>
        <div class="grid md:grid-cols-2 gap-4 text-sm text-gray-600">
          <div>
            <p><strong>ğŸ“… æ—¥æœŸæŸ¥è©¢ï¼š</strong>å¯é¸æ“‡ã€Œç™¼ç¥¨æ—¥æœŸã€æˆ–ã€Œç™»éŒ„æ™‚é–“ã€ä½œç‚ºæŸ¥è©¢ä¾æ“šï¼Œæ”¯æ´å¿«é€Ÿé¸æ“‡æ™‚é–“ç¯„åœ</p>
            <p><strong>ğŸ¢ å» å•†ç¯©é¸ï¼š</strong>å¯é¸æ“‡ç‰¹å®šå» å•†æˆ–æŸ¥çœ‹å…¨éƒ¨å» å•†çš„ç™¼ç¥¨è¨˜éŒ„</p>
          </div>
          <div>
            <p><strong>ğŸ“· åœ–ç‰‡æŸ¥è©¢ï¼š</strong>ä¸Šå‚³ç™¼ç¥¨ç…§ç‰‡é€²è¡Œæ™ºèƒ½æ¯”å°ï¼Œå¿«é€Ÿæ‰¾åˆ°ç›¸ä¼¼çš„ç™¼ç¥¨è¨˜éŒ„</p>
            <p><strong>ğŸ“Š æ‰¹é‡ä¸‹è¼‰ï¼š</strong>å‹¾é¸ç™¼ç¥¨å¾Œå¯ä¸€éµä¸‹è¼‰ Excel æ ¼å¼çš„è©³ç´°å ±è¡¨</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- æŸ¥è©¢è¡¨å–® -->
  <div class="search-form">
    <h2 class="text-2xl font-bold text-blue-700 mb-6 flex items-center gap-3">
      <i class="fas fa-sliders-h mr-2 text-xl"></i> æ™ºèƒ½æŸ¥è©¢è¨­å®š
    </h2>
    
    <form method="POST" action="{{ url_for('search') }}">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <!-- å» å•†é¸æ“‡ -->
        <div>
          <label for="vendor" class="block font-semibold mb-3 text-blue-700 flex items-center gap-2">
            <i class="fas fa-industry mr-2 text-lg"></i> é¸æ“‡å» å•†ï¼š
          </label>
          <select id="vendor" name="vendor" class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 text-lg input-enhanced focus:border-blue-500">
            <option value="">ğŸŒ å…¨éƒ¨å» å•†</option>
            {% for c in companies %}
              <option value="{{ c.id }}" {% if selected_vendor and selected_vendor == c.id %}selected{% endif %}>
                {{ c.co_na }}
              </option>
            {% endfor %}
          </select>
          <p class="text-sm text-gray-500 mt-1">é¸æ“‡ç‰¹å®šå» å•†æˆ–æŸ¥çœ‹å…¨éƒ¨</p>
        </div>

        <!-- æ—¥æœŸä¾æ“š -->
        <div>
          <label for="date_mode" class="block font-semibold mb-3 text-blue-700 flex items-center gap-2">
            <i class="fas fa-calendar-alt mr-2 text-lg"></i> æ—¥æœŸä¾æ“šï¼š
          </label>
          <select id="date_mode" name="date_mode" class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 text-lg input-enhanced focus:border-blue-500">
            <option value="in_date" {% if date_mode != 'created_at' %}selected{% endif %}>ğŸ“„ ç™¼ç¥¨æ—¥æœŸ</option>
            <option value="created_at" {% if date_mode == 'created_at' %}selected{% endif %}>â° ç™»éŒ„æ™‚é–“</option>
          </select>
          <p class="text-sm text-gray-500 mt-1">é¸æ“‡æŸ¥è©¢çš„æ™‚é–“åŸºæº–</p>
        </div>

        <!-- æ—¥æœŸå€é–“ -->
        <div>
          <label for="date_range" class="block font-semibold mb-3 text-blue-700 flex items-center gap-2">
            <i class="fas fa-calendar-day mr-2 text-lg"></i> æ—¥æœŸå€é–“ï¼š
          </label>
          <input id="date_range" name="date_range" type="text" placeholder="YYYY-MM-DD - YYYY-MM-DD"
                 class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 bg-white cursor-pointer text-lg input-enhanced"
                 value="{{ date_range or '' }}" />
          <div class="flex flex-wrap gap-2 mt-3">
            <button type="button" class="quick px-3 py-2 rounded-lg text-sm font-medium" data-range="this_month">ğŸ“… æœ¬æœˆ</button>
            <button type="button" class="quick px-3 py-2 rounded-lg text-sm font-medium" data-range="last_3m">ğŸ“Š è¿‘ä¸‰å€‹æœˆ</button>
            <button type="button" class="quick px-3 py-2 rounded-lg text-sm font-medium" data-range="ytd">ğŸ“ˆ ä»Šå¹´è‡³ä»Š</button>
            <button type="button" class="quick px-3 py-2 rounded-lg text-sm font-medium" data-range="clear">ğŸ—‘ï¸ æ¸…é™¤</button>
          </div>
        </div>

        <!-- æŸ¥è©¢æŒ‰éˆ• -->
        <div class="flex items-end">
          <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-4 rounded-xl font-semibold shadow inline-flex items-center text-lg transition hover:from-blue-700 hover:to-blue-800 hover:scale-105">
            <i class="fas fa-search mr-2"></i> é–‹å§‹æŸ¥è©¢
          </button>
        </div>
      </div>
    </form>
  </div>

  <!-- åœ–ç‰‡æŸ¥è©¢å€å¡Š -->
  <div class="card p-6 mb-8">
    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-3">
      <span class="text-2xl">ğŸ“·</span>
      æ™ºèƒ½åœ–ç‰‡æŸ¥è©¢
    </h3>
    <p class="text-gray-600 mb-4">ä¸Šå‚³ç™¼ç¥¨ç…§ç‰‡ï¼Œç³»çµ±å°‡è‡ªå‹•æ¯”å°ç›¸ä¼¼çš„ç™¼ç¥¨è¨˜éŒ„ï¼Œè®“æ‚¨å¿«é€Ÿæ‰¾åˆ°ç›®æ¨™è³‡æ–™</p>
    
    <form id="photoSearch" action="/search/photo" method="post" enctype="multipart/form-data" class="photo-search">
      <input id="photoInput" type="file" name="photos" accept="image/*" multiple style="display:none">
      <button type="button" id="photoBtn" class="btn flex items-center gap-2">
        <span class="text-lg">ğŸ“·</span>
        é¸æ“‡ç…§ç‰‡æŸ¥è©¢
      </button>
      <span id="photoName" class="chip">ğŸ“‚ æœªé¸æ“‡æª”æ¡ˆ</span>
      <button type="submit" id="photoSubmit" class="btn btn-outline flex items-center gap-2" disabled>
        <span class="text-lg">ğŸš€</span>
        é–‹å§‹æ¯”å°
      </button>
    </form>
    
    <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
      <h4 class="font-semibold text-blue-800 mb-2">ğŸ’¡ ä½¿ç”¨æç¤ºï¼š</h4>
      <ul class="text-sm text-blue-700 space-y-1">
        <li>â€¢ æ”¯æ´ JPGã€PNG ç­‰å¸¸è¦‹åœ–ç‰‡æ ¼å¼</li>
        <li>â€¢ å¯åŒæ™‚ä¸Šå‚³å¤šå¼µç…§ç‰‡é€²è¡Œæ‰¹é‡æ¯”å°</li>
        <li>â€¢ å»ºè­°ä¸Šå‚³æ¸…æ™°ã€å®Œæ•´çš„ç™¼ç¥¨ç…§ç‰‡ä»¥ç²å¾—æœ€ä½³æ¯”å°æ•ˆæœ</li>
        <li>â€¢ ç³»çµ±æœƒè‡ªå‹•è­˜åˆ¥ç™¼ç¥¨å…§å®¹ä¸¦æ‰¾å‡ºç›¸ä¼¼è¨˜éŒ„</li>
      </ul>
    </div>
  </div>

  <!-- ç™¼ç¥¨æ¸…å–® -->
  <div class="card p-6">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-2xl font-bold text-blue-700 flex items-center gap-3">
        <i class="fas fa-list-alt mr-2 text-2xl"></i> ç™¼ç¥¨æ¸…å–®
      </h2>
      {% if invoices %}
        <div class="text-sm text-gray-500">
          å…±æ‰¾åˆ° <span class="font-bold text-blue-600">{{ invoices|length }}</span> ç­†è¨˜éŒ„
        </div>
      {% endif %}
    </div>
    
    <!-- æ“ä½œæŒ‰éˆ•å€ -->
    <div class="mb-6 flex flex-wrap items-center gap-4">
      <button id="downloadExcelBtn" class="bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white px-6 py-3 rounded-lg font-semibold transition-all duration-300 transform hover:scale-105 shadow-lg flex items-center gap-2">
        <span class="text-lg">ğŸ“Š</span>
        ä¸‹è¼‰ Excel å ±è¡¨
      </button>
      <div class="text-gray-500 text-sm flex items-center gap-2">
        <span class="text-lg">ğŸ’¡</span>
        å‹¾é¸è¦ä¸‹è¼‰çš„ç™¼ç¥¨ï¼Œæ”¯æ´æ‰¹é‡åŒ¯å‡ºè©³ç´°è³‡æ–™
      </div>
    </div>
    
    <!-- è¡¨æ ¼å®¹å™¨ -->
    <div class="table-container">
      <div class="overflow-x-auto">
        <table class="min-w-full enhanced-table">
          <thead>
            <tr>
              <th class="px-6 py-4"><input type="checkbox" id="checkAllInvoices" class="w-4 h-4" /></th>
              <th class="px-6 py-4">ğŸ“„ ç™¼ç¥¨è™Ÿç¢¼</th>
              <th class="px-6 py-4">ğŸ¢ çµ±ä¸€ç·¨è™Ÿ</th>
              <th class="px-6 py-4">
                {% if date_mode == 'created_at' %}â° ç™»éŒ„æ—¥æœŸ{% else %}ğŸ“… ç™¼ç¥¨æ—¥æœŸ{% endif %}
              </th>
              <th class="px-6 py-4">ğŸ’° åƒ¹æ ¼</th>
              <th class="px-6 py-4">ğŸª å…¬å¸åç¨±</th>
              <th class="px-6 py-4">ğŸ“ ç™»éŒ„æ™‚é–“</th>
              <th class="px-6 py-4">ğŸ–¼ï¸ æŸ¥çœ‹åœ–ç‰‡</th>
            </tr>
          </thead>
          <tbody>
            {% if invoices %}
              {% for inv in invoices %}
                <tr class="transition-colors duration-200">
                  <td class="px-6 py-4 text-center">
                    <input type="checkbox" class="invoiceCheck w-4 h-4" data-idx="{{ loop.index0 }}" />
                  </td>
                  <td class="px-6 py-4 font-mono text-blue-600 font-semibold">{{ inv.num }}</td>
                  <td class="px-6 py-4 font-mono">{{ inv.snu }}</td>
                  <td class="px-6 py-4">
                    {% if date_mode == 'created_at' %}
                      <span class="text-gray-600">{{ inv.ctime }}</span>
                    {% else %}
                      <span class="text-gray-600">{{ inv.data }}</span>
                    {% endif %}
                  </td>
                  <td class="px-6 py-4 font-semibold text-green-600">NT$ {{ inv.price }}</td>
                  <td class="px-6 py-4 font-medium">{{ inv.bun }}</td>
                  <td class="px-6 py-4 text-gray-500 text-sm">{{ inv.ctime }}</td>
                  <td class="px-6 py-4">
                    {% if inv.img_url %}
                      <button type="button" class="btn btn-outline py-2 px-4 text-sm" data-preview="{{ inv.img_url }}">
                        ğŸ–¼ï¸ é è¦½
                      </button>
                    {% else %}
                      <span class="text-gray-400 text-sm">ç„¡é™„ä»¶</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="8" class="text-center py-12">
                  <div class="flex flex-col items-center gap-4">
                    <div class="text-6xl text-blue-200"><i class="fas fa-inbox"></i></div>
                    <div class="text-xl text-blue-700">ç›®å‰æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„ç™¼ç¥¨è¨˜éŒ„</div>
                    <div class="text-sm text-blue-400">è«‹å˜—è©¦èª¿æ•´æŸ¥è©¢æ¢ä»¶æˆ–ä½¿ç”¨åœ–ç‰‡æŸ¥è©¢åŠŸèƒ½</div>
                  </div>
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ä½¿ç”¨æŒ‡å— -->
  <div class="mt-8 grid md:grid-cols-2 gap-6">
    <!-- æŸ¥è©¢æŠ€å·§ -->
    <div class="card p-6">
      <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-3">
        <span class="text-2xl">ğŸ’¡</span>
        æŸ¥è©¢æŠ€å·§
      </h3>
      <div class="space-y-3 text-gray-600">
        <div class="flex items-start gap-3">
          <span class="text-blue-500 font-bold">1.</span>
          <div>
            <strong>ç²¾ç¢ºæŸ¥è©¢ï¼š</strong>é¸æ“‡ç‰¹å®šå» å•†å’Œæ˜ç¢ºçš„æ—¥æœŸç¯„åœï¼Œå¯ä»¥å¿«é€Ÿç¸®å°æŸ¥è©¢çµæœ
          </div>
        </div>
        <div class="flex items-start gap-3">
          <span class="text-blue-500 font-bold">2.</span>
          <div>
            <strong>æ¨¡ç³ŠæŸ¥è©¢ï¼š</strong>ä½¿ç”¨åœ–ç‰‡æŸ¥è©¢åŠŸèƒ½ï¼Œå³ä½¿ä¸è¨˜å¾—ç¢ºåˆ‡çš„ç™¼ç¥¨è³‡è¨Šä¹Ÿèƒ½æ‰¾åˆ°ç›¸é—œè¨˜éŒ„
          </div>
        </div>
        <div class="flex items-start gap-3">
          <span class="text-blue-500 font-bold">3.</span>
          <div>
            <strong>æ‰¹é‡æ“ä½œï¼š</strong>ä½¿ç”¨å…¨é¸åŠŸèƒ½å¿«é€Ÿé¸æ“‡å¤šç­†è¨˜éŒ„ï¼Œä¸€æ¬¡æ€§ä¸‹è¼‰æ‰€éœ€è³‡æ–™
          </div>
        </div>
      </div>
    </div>

    <!-- åŠŸèƒ½èªªæ˜ -->
    <div class="card p-6">
      <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-3">
        <span class="text-2xl">ğŸ”§</span>
        åŠŸèƒ½èªªæ˜
      </h3>
      <div class="space-y-3 text-gray-600">
        <div class="flex items-start gap-3">
          <span class="text-green-500">ğŸ“Š</span>
          <div>
            <strong>Excel åŒ¯å‡ºï¼š</strong>æ”¯æ´å°‡æŸ¥è©¢çµæœåŒ¯å‡ºç‚º Excel æ ¼å¼ï¼Œæ–¹ä¾¿å¾ŒçºŒåˆ†æå’Œå ±å‘Š
          </div>
        </div>
        <div class="flex items-start gap-3">
          <span class="text-purple-500">ğŸ“·</span>
          <div>
            <strong>åœ–ç‰‡æ¯”å°ï¼š</strong>ä½¿ç”¨ AI æŠ€è¡“åˆ†æç™¼ç¥¨åœ–ç‰‡ï¼Œè‡ªå‹•æ‰¾å‡ºç›¸ä¼¼çš„æ­·å²è¨˜éŒ„
          </div>
        </div>
        <div class="flex items-start gap-3">
          <span class="text-orange-500">ğŸ–¼ï¸</span>
          <div>
            <strong>åœ–ç‰‡é è¦½ï¼š</strong>é»æ“Šé è¦½æŒ‰éˆ•å¯æŸ¥çœ‹ç™¼ç¥¨çš„åŸå§‹åœ–ç‰‡ï¼Œç¢ºèªè³‡æ–™æº–ç¢ºæ€§
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- å¸¸è¦‹å•é¡Œ -->
  <div class="mt-8 card p-6 bg-blue-50 border-l-4 border-blue-400">
    <h3 class="text-xl font-bold text-blue-700 mb-6 flex items-center gap-3">
      <i class="fas fa-question-circle mr-2 text-2xl"></i> å¸¸è¦‹å•é¡Œ Q&A
    </h3>
    <div class="space-y-4">
      <details class="bg-gray-50 rounded-lg p-4 cursor-pointer">
        <summary class="font-semibold text-gray-700 flex items-center gap-2">
          <span class="text-blue-500">Q:</span>
          ç‚ºä»€éº¼æˆ‘çš„æŸ¥è©¢çµæœæ˜¯ç©ºçš„ï¼Ÿ
        </summary>
        <div class="mt-3 text-gray-600 pl-6">
          <strong>A:</strong> è«‹æª¢æŸ¥ä»¥ä¸‹å¹¾é»ï¼š
          <ul class="list-disc ml-4 mt-2 space-y-1">
            <li>ç¢ºèªé¸æ“‡çš„æ—¥æœŸç¯„åœæ˜¯å¦æ­£ç¢º</li>
            <li>æª¢æŸ¥æ˜¯å¦é¸æ“‡äº†æ­£ç¢ºçš„å» å•†</li>
            <li>ç¢ºèªã€Œæ—¥æœŸä¾æ“šã€çš„è¨­å®šï¼ˆç™¼ç¥¨æ—¥æœŸ vs ç™»éŒ„æ™‚é–“ï¼‰</li>
            <li>å˜—è©¦æ”¾å¯¬æŸ¥è©¢æ¢ä»¶æˆ–ä½¿ç”¨ã€Œå…¨éƒ¨å» å•†ã€é¸é …</li>
          </ul>
        </div>
      </details>
      
      <details class="bg-gray-50 rounded-lg p-4 cursor-pointer">
        <summary class="font-semibold text-gray-700 flex items-center gap-2">
          <span class="text-blue-500">Q:</span>
          åœ–ç‰‡æŸ¥è©¢åŠŸèƒ½å¦‚ä½•ä½¿ç”¨ï¼Ÿ
        </summary>
        <div class="mt-3 text-gray-600 pl-6">
          <strong>A:</strong> åœ–ç‰‡æŸ¥è©¢ä½¿ç”¨æ­¥é©Ÿï¼š
          <ul class="list-disc ml-4 mt-2 space-y-1">
            <li>é»æ“Šã€Œé¸æ“‡ç…§ç‰‡æŸ¥è©¢ã€æŒ‰éˆ•ä¸Šå‚³ç™¼ç¥¨åœ–ç‰‡</li>
            <li>ç³»çµ±æœƒè‡ªå‹•åˆ†æåœ–ç‰‡å…§å®¹ä¸¦èˆ‡è³‡æ–™åº«æ¯”å°</li>
            <li>æ¯”å°å®Œæˆå¾Œæœƒé¡¯ç¤ºç›¸ä¼¼åº¦æœ€é«˜çš„ç™¼ç¥¨è¨˜éŒ„</li>
            <li>å»ºè­°ä¸Šå‚³æ¸…æ™°ã€å®Œæ•´çš„ç™¼ç¥¨ç…§ç‰‡ä»¥ç²å¾—æœ€ä½³æ•ˆæœ</li>
          </ul>
        </div>
      </details>
      
      <details class="bg-gray-50 rounded-lg p-4 cursor-pointer">
        <summary class="font-semibold text-gray-700 flex items-center gap-2">
          <span class="text-blue-500">Q:</span>
          å¦‚ä½•ä¸‹è¼‰æŸ¥è©¢çµæœï¼Ÿ
        </summary>
        <div class="mt-3 text-gray-600 pl-6">
          <strong>A:</strong> Excel ä¸‹è¼‰æ­¥é©Ÿï¼š
          <ul class="list-disc ml-4 mt-2 space-y-1">
            <li>åœ¨æŸ¥è©¢çµæœä¸­å‹¾é¸éœ€è¦ä¸‹è¼‰çš„ç™¼ç¥¨è¨˜éŒ„</li>
            <li>å¯ä½¿ç”¨è¡¨é ­çš„æ ¸å–æ–¹å¡Šå…¨é¸æ‰€æœ‰è¨˜éŒ„</li>
            <li>é»æ“Šã€Œä¸‹è¼‰ Excel å ±è¡¨ã€æŒ‰éˆ•</li>
            <li>ç³»çµ±æœƒè‡ªå‹•ç”¢ç”ŸåŒ…å«å®Œæ•´è³‡è¨Šçš„ CSV æª”æ¡ˆ</li>
          </ul>
        </div>
      </details>
    </div>
  </div>
</div>

<!-- åœ–ç‰‡é è¦½æ¨¡æ…‹æ¡† -->
<div id="imgModal" class="modal" aria-hidden="true">
  <div class="backdrop"></div>
  <div class="dialog">
    <header>
      <div>ç™¼ç¥¨åœ–ç‰‡é è¦½</div>
      <button type="button" class="close" aria-label="é—œé–‰é è¦½">&times;</button>
    </header>
    <div class="body">
      <img id="modalImg" src="" alt="ç™¼ç¥¨åœ–ç‰‡">
    </div>
  </div>
</div>

<script>
// Excel ä¸‹è¼‰åŠŸèƒ½
document.addEventListener('DOMContentLoaded', () => {
  const downloadBtn = document.getElementById('downloadExcelBtn');
  const checkAll = document.getElementById('checkAllInvoices');
  const invoiceChecks = () => Array.from(document.querySelectorAll('.invoiceCheck'));
  
  // å…¨é¸åŠŸèƒ½
  if (checkAll) {
    checkAll.addEventListener('change', () => {
      invoiceChecks().forEach(chk => chk.checked = checkAll.checked);
      updateDownloadBtn();
    });
  }
  
  // ç›£è½å–®é¸è®ŠåŒ–
  invoiceChecks().forEach(chk => {
    chk.addEventListener('change', updateDownloadBtn);
  });
  
  // æ›´æ–°ä¸‹è¼‰æŒ‰éˆ•ç‹€æ…‹
  function updateDownloadBtn() {
    const checkedCount = invoiceChecks().filter(chk => chk.checked).length;
    if (downloadBtn) {
      if (checkedCount > 0) {
        downloadBtn.innerHTML = `<span class="text-lg">ğŸ“Š</span> ä¸‹è¼‰ Excel å ±è¡¨ (${checkedCount} ç­†)`;
        downloadBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      } else {
        downloadBtn.innerHTML = '<span class="text-lg">ğŸ“Š</span> ä¸‹è¼‰ Excel å ±è¡¨';
        downloadBtn.classList.add('opacity-50', 'cursor-not-allowed');
      }
    }
  }
  
  // ä¸‹è¼‰åŠŸèƒ½
  if (downloadBtn) {
    downloadBtn.addEventListener('click', () => {
      const rows = [];
      // æ¨™é¡Œè¡Œ
      rows.push(['ç™¼ç¥¨è™Ÿç¢¼','çµ±ä¸€ç·¨è™Ÿ','æ—¥æœŸ','åƒ¹æ ¼','å…¬å¸åç¨±','ç™»éŒ„æ™‚é–“','é¡åˆ¥1','é¡åˆ¥2','é¡åˆ¥3','é¡åˆ¥4']);
      
      let downloadCount = 0;
      invoiceChecks().forEach((chk, idx) => {
        if (chk.checked) {
          const tr = chk.closest('tr');
          const tds = tr.querySelectorAll('td');
          // æå–æ¬„ä½è³‡æ–™
          const num = tds[1]?.textContent.trim() || '';
          const snu = tds[2]?.textContent.trim() || '';
          const date = tds[3]?.textContent.trim() || '';
          const price = tds[4]?.textContent.trim() || '';
          const bun = tds[5]?.textContent.trim() || '';
          const ctime = tds[6]?.textContent.trim() || '';
          // é ç•™é¡åˆ¥æ¬„ä½ï¼ˆéœ€å¾Œç«¯è£œå……ï¼‰
          const cat1 = tr.dataset.cat1 || '';
          const cat2 = tr.dataset.cat2 || '';
          const cat3 = tr.dataset.cat3 || '';
          const cat4 = tr.dataset.cat4 || '';
          
          rows.push([num, snu, date, price, bun, ctime, cat1, cat2, cat3, cat4]);
          downloadCount++;
        }
      });
      
      if (downloadCount === 0) { 
        alert('è«‹å‹¾é¸è¦ä¸‹è¼‰çš„ç™¼ç¥¨è¨˜éŒ„'); 
        return; 
      }
      
      // ç”¢ç”Ÿ CSV æª”æ¡ˆï¼ˆExcel å¯ç›´æ¥é–‹å•Ÿï¼‰
      const csv = rows.map(r => r.map(cell => `"${cell}"`).join(',')).join('\n');
      const blob = new Blob(["\uFEFF" + csv], {type: "text/csv;charset=utf-8;"});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `ç™¼ç¥¨å ±è¡¨_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a); 
      a.click(); 
      document.body.removeChild(a);
      
      // é¡¯ç¤ºä¸‹è¼‰æˆåŠŸè¨Šæ¯
      const toast = document.createElement('div');
      toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
      toast.innerHTML = `âœ… æˆåŠŸä¸‹è¼‰ ${downloadCount} ç­†ç™¼ç¥¨è³‡æ–™`;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.remove();
      }, 3000);
    });
  }
});
  // æ—¥æœŸé¸æ“‡å™¨åˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', () => {
    // æ¸…é™¤ Litepicker çš„ã€Œæœ€è¿‘ç¯„åœã€æç¤º
    localStorage.removeItem('litepicker:recent-ranges');

    const dr = document.getElementById('date_range');
    const picker = new Litepicker({
      element: dr,
      singleMode: false,
      format: 'YYYY-MM-DD',
      autoApply: true,
      numberOfMonths: 2,
      numberOfColumns: 2,
      showTooltip: false,
      dropdowns: {
        minYear: 2018,
        maxYear: new Date().getFullYear(),
        months: true,
        years: true
      },
      lang: 'zh-tw'
    });

    // å¿«é€Ÿæ—¥æœŸé¸æ“‡åŠŸèƒ½
    function setQuickRange(type) {
      const today = new Date();
      const y = today.getFullYear();
      const m = today.getMonth();
      let s, e;
      
      if (type === 'this_month') {
        s = new Date(y, m, 1); 
        e = new Date(y, m + 1, 0);
      } else if (type === 'last_3m') {
        e = today; 
        s = new Date(y, m - 2, 1);
      } else if (type === 'ytd') {
        s = new Date(y, 0, 1); 
        e = today;
      } else if (type === 'clear') {
        dr.value = ''; 
        picker.clearSelection(); 
        return;
      }
      
      const pad = n => String(n).padStart(2, '0');
      const fmt = d => `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
      dr.value = `${fmt(s)} - ${fmt(e)}`;
      picker.setDateRange(s, e, true);
    }

    // ç¶å®šå¿«é€Ÿé¸æ“‡æŒ‰éˆ•
    document.querySelectorAll('button.quick').forEach(btn => {
      btn.addEventListener('click', () => {
        // ç§»é™¤å…¶ä»–æŒ‰éˆ•çš„é¸ä¸­ç‹€æ…‹
        document.querySelectorAll('button.quick').forEach(b => {
          b.classList.remove('bg-blue-500', 'text-white');
          b.classList.add('bg-white', 'text-gray-600');
        });
        
        // æ·»åŠ ç•¶å‰æŒ‰éˆ•çš„é¸ä¸­ç‹€æ…‹
        if (btn.dataset.range !== 'clear') {
          btn.classList.remove('bg-white', 'text-gray-600');
          btn.classList.add('bg-blue-500', 'text-white');
        }
        
        setQuickRange(btn.dataset.range);
      });
    });
  });
  // ç…§ç‰‡æŸ¥è©¢åŠŸèƒ½
  const photoInput  = document.getElementById('photoInput');
  const photoBtn    = document.getElementById('photoBtn');
  const photoName   = document.getElementById('photoName');
  const photoSubmit = document.getElementById('photoSubmit');
  const photoForm   = document.getElementById('photoSearch');

  if (photoBtn && photoInput) {
    photoBtn.addEventListener('click', () => photoInput.click());
    
    photoInput.addEventListener('change', () => {
      const files = photoInput.files || [];
      if (files.length > 0) {
        if (files.length === 1) {
          photoName.textContent = `ğŸ“„ ${files[0].name}`;
        } else {
          photoName.textContent = `ğŸ“‚ å·²é¸æ“‡ ${files.length} å¼µç…§ç‰‡`;
        }
        photoSubmit.disabled = false;
        photoSubmit.classList.remove('opacity-50', 'cursor-not-allowed');
        
        // é¡¯ç¤ºä¸Šå‚³é€²åº¦æç¤º
        const uploadHint = document.createElement('div');
        uploadHint.className = 'text-sm text-green-600 mt-2 flex items-center gap-2';
        uploadHint.innerHTML = 'âœ… ç…§ç‰‡å·²æº–å‚™å°±ç·’ï¼Œé»æ“Šã€Œé–‹å§‹æ¯”å°ã€é€²è¡Œåˆ†æ';
        
        const existingHint = photoForm.querySelector('.text-green-600');
        if (existingHint) existingHint.remove();
        photoForm.appendChild(uploadHint);
        
        // è‡ªå‹•é€å‡ºï¼ˆå¯é¸ï¼‰
        // photoForm.submit();
      } else {
        photoName.textContent = 'ğŸ“‚ æœªé¸æ“‡æª”æ¡ˆ';
        photoSubmit.disabled = true;
        photoSubmit.classList.add('opacity-50', 'cursor-not-allowed');
        
        const existingHint = photoForm.querySelector('.text-green-600');
        if (existingHint) existingHint.remove();
      }
    });
    
    // æ‹–æ‹½ä¸Šå‚³åŠŸèƒ½
    const photoSearchDiv = document.querySelector('.photo-search');
    
    photoSearchDiv.addEventListener('dragover', (e) => {
      e.preventDefault();
      photoSearchDiv.classList.add('border-purple-500', 'bg-purple-50');
    });
    
    photoSearchDiv.addEventListener('dragleave', (e) => {
      e.preventDefault();
      photoSearchDiv.classList.remove('border-purple-500', 'bg-purple-50');
    });
    
    photoSearchDiv.addEventListener('drop', (e) => {
      e.preventDefault();
      photoSearchDiv.classList.remove('border-purple-500', 'bg-purple-50');
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        photoInput.files = files;
        photoInput.dispatchEvent(new Event('change'));
      }
    });
  }

  // åœ–ç‰‡é è¦½æ¨¡æ…‹æ¡†åŠŸèƒ½
  const modal    = document.getElementById('imgModal');
  const modalImg = document.getElementById('modalImg');
  const closeBtn = modal?.querySelector('.close');

  function openModal(url) {
    if (!modal) return;
    modalImg.src = url;
    modal.classList.add('show');
    modal.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden'; // é˜²æ­¢èƒŒæ™¯æ»¾å‹•
  }
  
  function closeModal() {
    if (!modal) return;
    modal.classList.remove('show');
    modal.setAttribute('aria-hidden', 'true');
    modalImg.src = '';
    document.body.style.overflow = ''; // æ¢å¾©æ»¾å‹•
  }

  // ç¶å®šæ¯å€‹ã€Œé è¦½ã€æŒ‰éˆ•
  document.addEventListener('click', (e) => {
    if (e.target.hasAttribute('data-preview') || e.target.parentElement.hasAttribute('data-preview')) {
      const btn = e.target.hasAttribute('data-preview') ? e.target : e.target.parentElement;
      openModal(btn.dataset.preview);
    }
  });

  // é—œé–‰è¡Œç‚ºï¼šæŒ‰ Ã—ã€æŒ‰èƒŒæ™¯ã€æŒ‰ Esc
  closeBtn?.addEventListener('click', closeModal);
  modal?.querySelector('.backdrop')?.addEventListener('click', closeModal);
  document.addEventListener('keydown', (e) => { 
    if (e.key === 'Escape') closeModal(); 
  });

  // è¡¨æ ¼è¡Œæ‡¸åœæ•ˆæœ
  const tableRows = document.querySelectorAll('.enhanced-table tbody tr');
  tableRows.forEach(row => {
    row.addEventListener('mouseenter', () => {
      row.style.transform = 'scale(1.01)';
      row.style.zIndex = '1';
    });
    
    row.addEventListener('mouseleave', () => {
      row.style.transform = '';
      row.style.zIndex = '';
    });
  });

</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}å„å» å•†ç™¼ç¥¨ç´€éŒ„{% endblock %}

{% block head_extra %}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css" />
  <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/bundle.js"></script>
  <style>
    /* ã€Œç”¨ç…§ç‰‡æŸ¥è©¢ã€å€å¡Š */
    .photo-search { display:flex; align-items:center; gap:.75rem; flex-wrap:wrap; margin: 0 0 1rem 0; }

    /* æŒ‰éˆ• */
    .btn { border:1px solid #1e40af; background:#1d4ed8; color:#fff; padding:.55rem 1rem; border-radius:.5rem; font-weight:600; cursor:pointer; }
    .btn:hover { background:#1e3a8a; }
    .btn-outline { background:#fff; color:#1d4ed8; border-color:#1d4ed8; }
    .btn-outline:hover { background:#eff6ff; }

    /* æª”åå°æ¨™ç±¤ */
    .chip { font-size:.9rem; padding:.35rem .6rem; border:1px solid #d1d5db; border-radius:.375rem; background:#f9fafb; color:#111827; }

    /* åœ–ç‰‡é è¦½ Modal */
    .modal { position:fixed; inset:0; display:none; z-index:60; }
    .modal.show { display:block; }
    .modal .backdrop { position:absolute; inset:0; background:rgba(0,0,0,.55); }
    .modal .dialog { position:relative; z-index:1; max-width:min(92vw, 1100px); margin:6vh auto; background:#111827; padding:0; border-radius:.75rem; box-shadow:0 20px 45px rgba(0,0,0,.35); }
    .modal header { display:flex; justify-content:space-between; align-items:center; padding:.6rem .9rem; color:#fff; background:#1f2937; border-top-left-radius:.75rem; border-top-right-radius:.75rem; }
    .modal .close { appearance:none; border:none; background:transparent; color:#9ca3af; font-size:1.6rem; cursor:pointer; padding:.2rem .4rem; line-height:1; }
    .modal .close:hover { color:#fff; }
    .modal .body { background:#000; }
    .modal .body img { display:block; max-width:100%; height:auto; margin:0 auto; }
  </style>
{% endblock %}

{% block content %}
<div class="px-10 py-8">
  <h2 class="text-3xl font-bold text-blue-700 mb-8 text-left">å„å» å•†ç™¼ç¥¨ç´€éŒ„</h2>

  <form method="POST" action="{{ url_for('search') }}">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10 text-lg">
      <!-- å» å•† -->
      <div>
        <label for="vendor" class="block font-semibold mb-2">é¸æ“‡å» å•†ï¼š</label>
        <select id="vendor" name="vendor" class="w-full border border-gray-400 rounded px-4 py-3 text-lg">
          <option value="">å…¨éƒ¨å» å•†</option>
          {% for c in companies %}
            <option value="{{ c.id }}" {% if selected_vendor and selected_vendor == c.id %}selected{% endif %}>
              {{ c.co_na }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- æ—¥æœŸä¾æ“š -->
      <div>
        <label for="date_mode" class="block font-semibold mb-2">æ—¥æœŸä¾æ“šï¼š</label>
        <select id="date_mode" name="date_mode" class="w-full border border-gray-400 rounded px-4 py-3 text-lg">
          <option value="in_date"    {% if date_mode != 'created_at' %}selected{% endif %}>ç™¼ç¥¨æ—¥æœŸ</option>
          <option value="created_at" {% if date_mode == 'created_at' %}selected{% endif %}>ç™»éŒ„æ™‚é–“</option>
        </select>
        <p class="text-sm text-gray-500 mt-1">ä¸‹æ–¹æ—¥æœŸå€é–“æœƒå¥—ç”¨åœ¨æ­¤æ¬„ä½</p>
      </div>

      <!-- æ—¥æœŸå€é–“ -->
      <div>
        <label for="date_range" class="block font-semibold mb-2">æ—¥æœŸå€é–“ï¼š</label>
        <input id="date_range" name="date_range" type="text" placeholder="YYYY-MM-DD - YYYY-MM-DD"
               class="w-full border border-gray-400 rounded px-4 py-3 bg-white cursor-pointer text-lg"
               value="{{ date_range or '' }}" />
        <div class="flex flex-wrap gap-2 mt-2 text-sm">
          <button type="button" class="quick px-3 py-1 rounded border" data-range="this_month">æœ¬æœˆ</button>
          <button type="button" class="quick px-3 py-1 rounded border" data-range="last_3m">è¿‘ä¸‰å€‹æœˆ</button>
          <button type="button" class="quick px-3 py-1 rounded border" data-range="ytd">ä»Šå¹´è‡³ä»Š</button>
          <button type="button" class="quick px-3 py-1 rounded border" data-range="clear">æ¸…é™¤</button>
        </div>
      </div>

      <!-- é€å‡º -->
      <div class="flex items-end self-end">
        <button type="submit" class="bg-blue-600 text-white px-6 py-3 rounded hover:bg-blue-700 text-lg font-semibold w-full">
          æŸ¥è©¢
        </button>
      </div>
    </div>
  </form>

  <form id="photoSearch" action="/search/photo" method="post" enctype="multipart/form-data" class="photo-search">
    <input id="photoInput" type="file" name="photos" accept="image/*" multiple style="display:none">
    <button type="button" id="photoBtn" class="btn">ğŸ“· ç”¨ç…§ç‰‡æŸ¥è©¢</button>
    <span id="photoName" class="chip">æœªé¸æ“‡æª”æ¡ˆ</span>
    <button type="submit" id="photoSubmit" class="btn btn-outline" disabled>é–‹å§‹æ¯”å°</button>
  </form>

  <div class="bg-white border border-gray-400 shadow rounded-lg p-6 text-lg">
    <h2 class="text-2xl font-bold mb-6 text-gray-800">ç™¼ç¥¨æ¸…å–®</h2>
    <div class="mb-4 flex items-center gap-4">
      <button id="downloadExcelBtn" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded text-base font-semibold">ä¸‹è¼‰ Excel</button>
      <span class="text-gray-500 text-sm">å¯å‹¾é¸è¦ä¸‹è¼‰çš„ç™¼ç¥¨</span>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full border border-black text-lg text-left">
        <thead class="bg-gray-200">
          <tr>
            <th class="border border-black px-6 py-3"><input type="checkbox" id="checkAllInvoices" /></th>
            <th class="border border-black px-6 py-3">ç™¼ç¥¨è™Ÿç¢¼</th>
            <th class="border border-black px-6 py-3">çµ±ä¸€ç·¨è™Ÿ</th>
            <th class="border border-black px-6 py-3">
              {% if date_mode == 'created_at' %}ç™»éŒ„æ—¥æœŸ{% else %}ç™¼ç¥¨æ—¥æœŸ{% endif %}
            </th>
            <th class="border border-black px-6 py-3">åƒ¹æ ¼</th>
            <th class="border border-black px-6 py-3">å…¬å¸åç¨±</th>
            <th class="border border-black px-6 py-3">ç™»éŒ„æ™‚é–“</th>
            <th class="border border-black px-6 py-3">æŸ¥çœ‹åœ–ç‰‡</th>
          </tr>
        </thead>
        <tbody>
          {% if invoices %}
            {% for inv in invoices %}
              <tr class="odd:bg-white even:bg-gray-100">
                <td class="border border-black px-6 py-3 text-center">
                  <input type="checkbox" class="invoiceCheck" data-idx="{{ loop.index0 }}" />
                </td>
                <td class="border border-black px-6 py-3">{{ inv.num }}</td>
                <td class="border border-black px-6 py-3">{{ inv.snu }}</td>
                <td class="border border-black px-6 py-3">
                  {% if date_mode == 'created_at' %}
                    {{ inv.ctime }}
                  {% else %}
                    {{ inv.data }}
                  {% endif %}
                </td>
                <td class="border border-black px-6 py-3">{{ inv.price }}</td>
                <td class="border border-black px-6 py-3">{{ inv.bun }}</td>
                <td class="border border-black px-6 py-3">{{ inv.ctime }}</td>
                <td class="border border-black px-6 py-3">
                  {% if inv.img_url %}
                    <button type="button" class="btn btn-outline" data-preview="{{ inv.img_url }}">é è¦½</button>
                  {% else %}
                    ç„¡é™„ä»¶
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="7" class="text-center py-6 text-gray-500">ç›®å‰æ²’æœ‰è³‡æ–™</td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
<!-- åœ–ç‰‡é è¦½ Modal -->
<div id="imgModal" class="modal" aria-hidden="true">
  <div class="backdrop"></div>
  <div class="dialog">
    <header>
      <div>ç™¼ç¥¨åœ–ç‰‡é è¦½</div>
      <button type="button" class="close" aria-label="é—œé–‰é è¦½">&times;</button>
    </header>
    <div class="body">
      <img id="modalImg" src="" alt="ç™¼ç¥¨åœ–ç‰‡">
    </div>
  </div>
</div>

<script>
// Excel ä¸‹è¼‰åŠŸèƒ½
document.addEventListener('DOMContentLoaded', () => {
  const downloadBtn = document.getElementById('downloadExcelBtn');
  const checkAll = document.getElementById('checkAllInvoices');
  const invoiceChecks = () => Array.from(document.querySelectorAll('.invoiceCheck'));
  if (checkAll) {
    checkAll.addEventListener('change', () => {
      invoiceChecks().forEach(chk => chk.checked = checkAll.checked);
    });
  }
  if (downloadBtn) {
    downloadBtn.addEventListener('click', () => {
      const rows = [];
      // æ¨™é¡Œ
        rows.push(['ç™¼ç¥¨è™Ÿç¢¼','çµ±ä¸€ç·¨è™Ÿ','æ—¥æœŸ','åƒ¹æ ¼','å…¬å¸åç¨±','ç™»å…¥æ™‚é–“','é¡åˆ¥1','é¡åˆ¥2','é¡åˆ¥3','é¡åˆ¥4']);
      invoiceChecks().forEach((chk, idx) => {
        if (chk.checked) {
          const tr = chk.closest('tr');
          const tds = tr.querySelectorAll('td');
          // å–æ¬„ä½
          const num = tds[1]?.textContent.trim() || '';
          const snu = tds[2]?.textContent.trim() || '';
          const date = tds[3]?.textContent.trim() || '';
          const price = tds[4]?.textContent.trim() || '';
          const bun = tds[5]?.textContent.trim() || '';
            const ctime = tds[6]?.textContent.trim() || '';
          // å‡è¨­å››å€‹é¡åˆ¥è³‡æ–™åœ¨ inv ç‰©ä»¶ä¸­ï¼Œéœ€å¾Œç«¯è£œå……
          // é€™è£¡ç”¨ data-* æˆ–éš±è—æ¬„ä½å‚³éï¼Œæš«ä»¥ç©ºå­—ä¸²
          const cat1 = tr.dataset.cat1 || '';
          const cat2 = tr.dataset.cat2 || '';
          const cat3 = tr.dataset.cat3 || '';
          const cat4 = tr.dataset.cat4 || '';
            rows.push([num, snu, date, price, bun, ctime, cat1, cat2, cat3, cat4]);
        }
      });
      if (rows.length <= 1) { alert('è«‹å‹¾é¸è¦ä¸‹è¼‰çš„ç™¼ç¥¨'); return; }
      // ç”¢ç”Ÿ CSV æª”æ¡ˆï¼ˆExcel å¯ç›´æ¥é–‹å•Ÿï¼‰
      const csv = rows.map(r => r.join(',')).join('\n');
      const blob = new Blob(["\uFEFF"+csv], {type: "text/csv;charset=utf-8;"});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'ç™¼ç¥¨ä¸‹è¼‰.csv';
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
    });
  }
});
  document.addEventListener('DOMContentLoaded', () => {
    // æ¸…é™¤ Litepicker çš„ã€Œæœ€è¿‘ç¯„åœã€æç¤º
    localStorage.removeItem('litepicker:recent-ranges');

    const dr = document.getElementById('date_range');
    const picker = new Litepicker({
      element: dr,
      singleMode: false,
      format: 'YYYY-MM-DD',
      autoApply: true,
      numberOfMonths: 2,
      numberOfColumns: 2,
      showTooltip: false,
      dropdowns: {
        minYear: 2018,
        maxYear: new Date().getFullYear(),
        months: true,
        years: true
      }
    });

    function setQuickRange(type) {
      const today = new Date();
      const y = today.getFullYear();
      const m = today.getMonth();
      let s, e;
      if (type === 'this_month') {
        s = new Date(y, m, 1); e = new Date(y, m + 1, 0);
      } else if (type === 'last_3m') {
        e = today; s = new Date(y, m - 2, 1);
      } else if (type === 'ytd') {
        s = new Date(y, 0, 1); e = today;
      } else if (type === 'clear') {
        dr.value = ''; picker.clearSelection(); return;
      }
      const pad = n => String(n).padStart(2, '0');
      const fmt = d => `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
      dr.value = `${fmt(s)} - ${fmt(e)}`;
      picker.setDateRange(s, e, true);
    }

    document.querySelectorAll('button.quick').forEach(btn => {
      btn.addEventListener('click', () => setQuickRange(btn.dataset.range));
    });
  });
  // --- ç”¨ç…§ç‰‡æŸ¥è©¢ï¼šå¥½çœ‹ + è‡ªå‹•é€å‡º ---
const photoInput  = document.getElementById('photoInput');
const photoBtn    = document.getElementById('photoBtn');
const photoName   = document.getElementById('photoName');
const photoSubmit = document.getElementById('photoSubmit');
const photoForm   = document.getElementById('photoSearch');

if (photoBtn && photoInput) {
  photoBtn.addEventListener('click', () => photoInput.click());
  photoInput.addEventListener('change', () => {
    const files = photoInput.files || [];
    if (files.length > 0) {
      photoName.textContent = files.length === 1 ? files[0].name : `å·²é¸æ“‡ ${files.length} å¼µ`;
      photoSubmit.disabled = false;
      photoForm.submit(); // é¸å®Œè‡ªå‹•é€å‡ºï¼›è‹¥æƒ³æ‰‹å‹•å°±æŠŠé€™è¡Œè¨»è§£æ‰
    } else {
      photoName.textContent = 'æœªé¸æ“‡æª”æ¡ˆ';
      photoSubmit.disabled = true;
    }
  });
}

// --- åœ–ç‰‡é è¦½ Modal ---
const modal    = document.getElementById('imgModal');
const modalImg = document.getElementById('modalImg');
const closeBtn = modal?.querySelector('.close');

function openModal(url){
  if (!modal) return;
  modalImg.src = url;
  modal.classList.add('show');
  modal.setAttribute('aria-hidden', 'false');
}
function closeModal(){
  if (!modal) return;
  modal.classList.remove('show');
  modal.setAttribute('aria-hidden', 'true');
  modalImg.src = '';
}

// ç¶å®šæ¯å€‹ã€Œé è¦½ã€æŒ‰éˆ•
document.querySelectorAll('[data-preview]').forEach(btn=>{
  btn.addEventListener('click', ()=> openModal(btn.dataset.preview));
});

// é—œé–‰è¡Œç‚ºï¼šæŒ‰ Ã—ã€æŒ‰èƒŒæ™¯ã€æŒ‰ Esc
closeBtn?.addEventListener('click', closeModal);
modal?.querySelector('.backdrop')?.addEventListener('click', closeModal);
document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeModal(); });

</script>
{% endblock %}
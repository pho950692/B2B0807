{% extends "base.html" %}

{% block title %}各廠商發票紀錄{% endblock %}

{% block head_extra %}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css" />
  <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/bundle.js"></script>
  <style>
    /* 「用照片查詢」區塊 */
    .photo-search { display:flex; align-items:center; gap:.75rem; flex-wrap:wrap; margin: 0 0 1rem 0; }

    /* 按鈕 */
    .btn { border:1px solid #1e40af; background:#1d4ed8; color:#fff; padding:.55rem 1rem; border-radius:.5rem; font-weight:600; cursor:pointer; }
    .btn:hover { background:#1e3a8a; }
    .btn-outline { background:#fff; color:#1d4ed8; border-color:#1d4ed8; }
    .btn-outline:hover { background:#eff6ff; }

    /* 檔名小標籤 */
    .chip { font-size:.9rem; padding:.35rem .6rem; border:1px solid #d1d5db; border-radius:.375rem; background:#f9fafb; color:#111827; }

    /* 圖片預覽 Modal */
    .modal { position:fixed; inset:0; display:none; z-index:60; }
    .modal.show { display:block; }
    .modal .backdrop { position:absolute; inset:0; background:rgba(0,0,0,.55); }
    .modal .dialog { position:relative; z-index:1; max-width:min(92vw, 1100px); margin:6vh auto; background:#111827; padding:0; border-radius:.75rem; box-shadow:0 20px 45px rgba(0,0,0,.35); }
    .modal header { display:flex; justify-content:space-between; align-items:center; padding:.6rem .9rem; color:#fff; background:#1f2937; border-top-left-radius:.75rem; border-top-right-radius:.75rem; }
    .modal .close { appearance:none; border:none; background:transparent; color:#9ca3af; font-size:1.6rem; cursor:pointer; padding:.2rem .4rem; line-height:1; }
    .modal .close:hover { color:#fff; }
    .modal .body { background:#000; }
    .modal .body img { display:block; max-width:100%; height:auto; margin:0 auto; }
  </style>
{% endblock %}

{% block content %}
<div class="px-10 py-8">
  <h2 class="text-3xl font-bold text-blue-700 mb-8 text-left">各廠商發票紀錄</h2>

  <form method="POST" action="{{ url_for('search') }}">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10 text-lg">
      <!-- 廠商 -->
      <div>
        <label for="vendor" class="block font-semibold mb-2">選擇廠商：</label>
        <select id="vendor" name="vendor" class="w-full border border-gray-400 rounded px-4 py-3 text-lg">
          <option value="">全部廠商</option>
          {% for c in companies %}
            <option value="{{ c.id }}" {% if selected_vendor and selected_vendor == c.id %}selected{% endif %}>
              {{ c.co_na }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- 日期依據 -->
      <div>
        <label for="date_mode" class="block font-semibold mb-2">日期依據：</label>
        <select id="date_mode" name="date_mode" class="w-full border border-gray-400 rounded px-4 py-3 text-lg">
          <option value="in_date"    {% if date_mode != 'created_at' %}selected{% endif %}>發票日期</option>
          <option value="created_at" {% if date_mode == 'created_at' %}selected{% endif %}>登錄時間</option>
        </select>
        <p class="text-sm text-gray-500 mt-1">下方日期區間會套用在此欄位</p>
      </div>

      <!-- 日期區間 -->
      <div>
        <label for="date_range" class="block font-semibold mb-2">日期區間：</label>
        <input id="date_range" name="date_range" type="text" placeholder="YYYY-MM-DD - YYYY-MM-DD"
               class="w-full border border-gray-400 rounded px-4 py-3 bg-white cursor-pointer text-lg"
               value="{{ date_range or '' }}" />
        <div class="flex flex-wrap gap-2 mt-2 text-sm">
          <button type="button" class="quick px-3 py-1 rounded border" data-range="this_month">本月</button>
          <button type="button" class="quick px-3 py-1 rounded border" data-range="last_3m">近三個月</button>
          <button type="button" class="quick px-3 py-1 rounded border" data-range="ytd">今年至今</button>
          <button type="button" class="quick px-3 py-1 rounded border" data-range="clear">清除</button>
        </div>
      </div>

      <!-- 送出 -->
      <div class="flex items-end self-end">
        <button type="submit" class="bg-blue-600 text-white px-6 py-3 rounded hover:bg-blue-700 text-lg font-semibold w-full">
          查詢
        </button>
      </div>
    </div>
  </form>

  <form id="photoSearch" action="/search/photo" method="post" enctype="multipart/form-data" class="photo-search">
    <input id="photoInput" type="file" name="photos" accept="image/*" multiple style="display:none">
    <button type="button" id="photoBtn" class="btn">📷 用照片查詢</button>
    <span id="photoName" class="chip">未選擇檔案</span>
    <button type="submit" id="photoSubmit" class="btn btn-outline" disabled>開始比對</button>
  </form>

  <div class="bg-white border border-gray-400 shadow rounded-lg p-6 text-lg">
    <h2 class="text-2xl font-bold mb-6 text-gray-800">發票清單</h2>
    <div class="mb-4 flex items-center gap-4">
      <button id="downloadExcelBtn" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded text-base font-semibold">下載 Excel</button>
      <span class="text-gray-500 text-sm">可勾選要下載的發票</span>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full border border-black text-lg text-left">
        <thead class="bg-gray-200">
          <tr>
            <th class="border border-black px-6 py-3"><input type="checkbox" id="checkAllInvoices" /></th>
            <th class="border border-black px-6 py-3">發票號碼</th>
            <th class="border border-black px-6 py-3">統一編號</th>
            <th class="border border-black px-6 py-3">
              {% if date_mode == 'created_at' %}登錄日期{% else %}發票日期{% endif %}
            </th>
            <th class="border border-black px-6 py-3">價格</th>
            <th class="border border-black px-6 py-3">公司名稱</th>
            <th class="border border-black px-6 py-3">登錄時間</th>
            <th class="border border-black px-6 py-3">查看圖片</th>
          </tr>
        </thead>
        <tbody>
          {% if invoices %}
            {% for inv in invoices %}
              <tr class="odd:bg-white even:bg-gray-100">
                <td class="border border-black px-6 py-3 text-center">
                  <input type="checkbox" class="invoiceCheck" data-idx="{{ loop.index0 }}" />
                </td>
                <td class="border border-black px-6 py-3">{{ inv.num }}</td>
                <td class="border border-black px-6 py-3">{{ inv.snu }}</td>
                <td class="border border-black px-6 py-3">
                  {% if date_mode == 'created_at' %}
                    {{ inv.ctime }}
                  {% else %}
                    {{ inv.data }}
                  {% endif %}
                </td>
                <td class="border border-black px-6 py-3">{{ inv.price }}</td>
                <td class="border border-black px-6 py-3">{{ inv.bun }}</td>
                <td class="border border-black px-6 py-3">{{ inv.ctime }}</td>
                <td class="border border-black px-6 py-3">
                  {% if inv.img_url %}
                    <button type="button" class="btn btn-outline" data-preview="{{ inv.img_url }}">預覽</button>
                  {% else %}
                    無附件
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="7" class="text-center py-6 text-gray-500">目前沒有資料</td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
<!-- 圖片預覽 Modal -->
<div id="imgModal" class="modal" aria-hidden="true">
  <div class="backdrop"></div>
  <div class="dialog">
    <header>
      <div>發票圖片預覽</div>
      <button type="button" class="close" aria-label="關閉預覽">&times;</button>
    </header>
    <div class="body">
      <img id="modalImg" src="" alt="發票圖片">
    </div>
  </div>
</div>

<script>
// Excel 下載功能
document.addEventListener('DOMContentLoaded', () => {
  const downloadBtn = document.getElementById('downloadExcelBtn');
  const checkAll = document.getElementById('checkAllInvoices');
  const invoiceChecks = () => Array.from(document.querySelectorAll('.invoiceCheck'));
  if (checkAll) {
    checkAll.addEventListener('change', () => {
      invoiceChecks().forEach(chk => chk.checked = checkAll.checked);
    });
  }
  if (downloadBtn) {
    downloadBtn.addEventListener('click', () => {
      const rows = [];
      // 標題
        rows.push(['發票號碼','統一編號','日期','價格','公司名稱','登入時間','類別1','類別2','類別3','類別4']);
      invoiceChecks().forEach((chk, idx) => {
        if (chk.checked) {
          const tr = chk.closest('tr');
          const tds = tr.querySelectorAll('td');
          // 取欄位
          const num = tds[1]?.textContent.trim() || '';
          const snu = tds[2]?.textContent.trim() || '';
          const date = tds[3]?.textContent.trim() || '';
          const price = tds[4]?.textContent.trim() || '';
          const bun = tds[5]?.textContent.trim() || '';
            const ctime = tds[6]?.textContent.trim() || '';
          // 假設四個類別資料在 inv 物件中，需後端補充
          // 這裡用 data-* 或隱藏欄位傳遞，暫以空字串
          const cat1 = tr.dataset.cat1 || '';
          const cat2 = tr.dataset.cat2 || '';
          const cat3 = tr.dataset.cat3 || '';
          const cat4 = tr.dataset.cat4 || '';
            rows.push([num, snu, date, price, bun, ctime, cat1, cat2, cat3, cat4]);
        }
      });
      if (rows.length <= 1) { alert('請勾選要下載的發票'); return; }
      // 產生 CSV 檔案（Excel 可直接開啟）
      const csv = rows.map(r => r.join(',')).join('\n');
      const blob = new Blob(["\uFEFF"+csv], {type: "text/csv;charset=utf-8;"});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = '發票下載.csv';
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
    });
  }
});
  document.addEventListener('DOMContentLoaded', () => {
    // 清除 Litepicker 的「最近範圍」提示
    localStorage.removeItem('litepicker:recent-ranges');

    const dr = document.getElementById('date_range');
    const picker = new Litepicker({
      element: dr,
      singleMode: false,
      format: 'YYYY-MM-DD',
      autoApply: true,
      numberOfMonths: 2,
      numberOfColumns: 2,
      showTooltip: false,
      dropdowns: {
        minYear: 2018,
        maxYear: new Date().getFullYear(),
        months: true,
        years: true
      }
    });

    function setQuickRange(type) {
      const today = new Date();
      const y = today.getFullYear();
      const m = today.getMonth();
      let s, e;
      if (type === 'this_month') {
        s = new Date(y, m, 1); e = new Date(y, m + 1, 0);
      } else if (type === 'last_3m') {
        e = today; s = new Date(y, m - 2, 1);
      } else if (type === 'ytd') {
        s = new Date(y, 0, 1); e = today;
      } else if (type === 'clear') {
        dr.value = ''; picker.clearSelection(); return;
      }
      const pad = n => String(n).padStart(2, '0');
      const fmt = d => `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
      dr.value = `${fmt(s)} - ${fmt(e)}`;
      picker.setDateRange(s, e, true);
    }

    document.querySelectorAll('button.quick').forEach(btn => {
      btn.addEventListener('click', () => setQuickRange(btn.dataset.range));
    });
  });
  // --- 用照片查詢：好看 + 自動送出 ---
const photoInput  = document.getElementById('photoInput');
const photoBtn    = document.getElementById('photoBtn');
const photoName   = document.getElementById('photoName');
const photoSubmit = document.getElementById('photoSubmit');
const photoForm   = document.getElementById('photoSearch');

if (photoBtn && photoInput) {
  photoBtn.addEventListener('click', () => photoInput.click());
  photoInput.addEventListener('change', () => {
    const files = photoInput.files || [];
    if (files.length > 0) {
      photoName.textContent = files.length === 1 ? files[0].name : `已選擇 ${files.length} 張`;
      photoSubmit.disabled = false;
      photoForm.submit(); // 選完自動送出；若想手動就把這行註解掉
    } else {
      photoName.textContent = '未選擇檔案';
      photoSubmit.disabled = true;
    }
  });
}

// --- 圖片預覽 Modal ---
const modal    = document.getElementById('imgModal');
const modalImg = document.getElementById('modalImg');
const closeBtn = modal?.querySelector('.close');

function openModal(url){
  if (!modal) return;
  modalImg.src = url;
  modal.classList.add('show');
  modal.setAttribute('aria-hidden', 'false');
}
function closeModal(){
  if (!modal) return;
  modal.classList.remove('show');
  modal.setAttribute('aria-hidden', 'true');
  modalImg.src = '';
}

// 綁定每個「預覽」按鈕
document.querySelectorAll('[data-preview]').forEach(btn=>{
  btn.addEventListener('click', ()=> openModal(btn.dataset.preview));
});

// 關閉行為：按 ×、按背景、按 Esc
closeBtn?.addEventListener('click', closeModal);
modal?.querySelector('.backdrop')?.addEventListener('click', closeModal);
document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeModal(); });

</script>
{% endblock %}
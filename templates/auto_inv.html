{% extends "base.html" %}

{% block title %}è¾¨è­˜ç™¼ç¥¨ - fastB2B{% endblock %}

{% block head_extra %}
  {% if 'user_id' not in session %}
    <script>alert('âš ï¸ æé†’ï¼šä½ å°šæœªç™»å…¥ï¼Œè¾¨è­˜çµæœä¸æœƒå„²å­˜åˆ°ç³»çµ±');</script>
  {% endif %}
{% endblock %}

{% block content %}

<div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-xl p-10 mt-10 animate__animated animate__fadeIn text-base md:text-lg">
  <h2 class="text-4xl font-extrabold text-blue-700 mb-4 flex items-center justify-center drop-shadow">
    <i class="fas fa-file-invoice mr-3"></i> è‡ªå‹•è¾¨è­˜ç™¼ç¥¨
  </h2>
  <p class="text-lg text-gray-700 mb-6 text-center font-semibold">æ”¯æ´ JPG / PNG / PDFï¼Œå¤šæª”æ‹–æ›³ä¸Šå‚³ï¼Œè‡ªå‹•è£åˆ‡èˆ‡ AI æ–‡å­—è¾¨è­˜ï¼Œå¿«é€Ÿå®Œæˆç™¼ç¥¨è³‡æ–™å»ºæª”ã€‚</p>

  <!-- ä½¿ç”¨æµç¨‹åœ–ç¤º -->
  <div class="grid grid-cols-4 gap-8 mb-8">
    <div class="flex flex-col items-center">
      <div class="text-3xl mb-2">ğŸ“¤</div>
      <div class="text-blue-700 font-bold">é¸æ“‡æª”æ¡ˆ</div>
      <div class="text-gray-500 text-sm">æ”¯æ´å¤šæª”æ‹–æ›³ã€è³‡æ–™å¤¾é¸å–</div>
    </div>
    <div class="flex flex-col items-center">
      <div class="text-3xl mb-2">ğŸ¤–</div>
      <div class="text-blue-700 font-bold">AIè¾¨è­˜</div>
      <div class="text-gray-500 text-sm">è‡ªå‹•åµæ¸¬æ¬„ä½ã€è¾¨è­˜æ–‡å­—</div>
    </div>
    <div class="flex flex-col items-center">
      <div class="text-3xl mb-2">ğŸ—‚ï¸</div>
      <div class="text-blue-700 font-bold">ç·¨è¼¯/ç¢ºèª</div>
      <div class="text-gray-500 text-sm">å¯äººå·¥ä¿®æ­£ã€æ‰¹æ¬¡å„²å­˜</div>
    </div>
    <div class="flex flex-col items-center">
      <div class="text-3xl mb-2">ğŸ“ˆ</div>
      <div class="text-blue-700 font-bold">åŒ¯å‡º/ä¸²æ¥</div>
      <div class="text-gray-500 text-sm">Excel/CSV åŒ¯å‡ºï¼ŒERPä¸²æ¥</div>
    </div>
  </div>

  <!-- é‡é»æç¤º -->
  <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded mb-8">
    <ul class="list-disc pl-6 text-blue-700 text-base space-y-1">
      <li>å»ºè­°åœ–ç‰‡è§£æåº¦ 300dpi ä»¥ä¸Šï¼Œæª”æ¡ˆå¤§å°æ¯å¼µä¸è¶…é 10MBã€‚</li>
      <li>ç³»çµ±è‡ªå‹•è¾¨è­˜ç™¼ç¥¨è™Ÿç¢¼ã€çµ±ä¸€ç·¨è™Ÿã€æ—¥æœŸã€é‡‘é¡ç­‰ä¸»è¦æ¬„ä½ã€‚</li>
      <li>è¾¨è­˜ç‡ä½æ™‚å¯äººå·¥ä¿®æ­£ï¼Œå†å„²å­˜åˆ°ç³»çµ±ã€‚</li>
      <li>å¦‚é‡è¾¨è­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥å½±åƒæ¸…æ™°åº¦æˆ–è¯çµ¡ç®¡ç†å“¡ã€‚</li>
    </ul>
  </div>

  <div class="mb-8 flex flex-wrap gap-4 items-center justify-center">
    <input type="file" id="filePicker" class="hidden" multiple accept=".jpg,.jpeg,.png,.pdf,image/*" />
    <input type="file" id="folderPicker" class="hidden" webkitdirectory directory accept=".jpg,.jpeg,.png,.pdf,image/*" />
    <button id="btnPickFiles" onclick="document.getElementById('filePicker').click()" class="bg-blue-100 hover:bg-blue-200 text-blue-700 text-lg px-6 py-3 rounded-lg font-bold shadow">
      <i class="fas fa-upload mr-2"></i> é¸æ“‡æª”æ¡ˆ
    </button>
    <button id="btnPickFolder" onclick="document.getElementById('folderPicker').click()" class="bg-blue-100 hover:bg-blue-200 text-blue-700 text-lg px-6 py-3 rounded-lg font-bold shadow">
      <i class="fas fa-folder-open mr-2"></i> é¸æ“‡è³‡æ–™å¤¾
    </button>
    <a href="/camera" class="bg-green-600 hover:bg-green-700 text-white text-lg px-6 py-3 rounded-lg font-bold shadow inline-flex items-center">
      <i class="fas fa-camera mr-2"></i> é–‹å•Ÿé¡é ­
    </a>
  </div>

  <!-- ç©ºç‹€æ…‹æ’åœ– -->
  <div id="emptyState" class="flex flex-col items-center justify-center py-12 text-gray-400" style="display:none;">
    <div class="text-7xl mb-4">ğŸ–¼ï¸</div>
    <div class="text-xl mb-2">å°šæœªé¸æ“‡æª”æ¡ˆï¼Œè«‹å…ˆé»é¸ä¸Šæ–¹æŒ‰éˆ•ä¸Šå‚³ç™¼ç¥¨åœ–ç‰‡æˆ– PDFã€‚</div>
    <div class="text-base">æ”¯æ´å¤šæª”æ‹–æ›³ã€è³‡æ–™å¤¾é¸å–ï¼Œæˆ–ä½¿ç”¨é¡é ­æ‹ç…§ã€‚</div>
  </div>

  <div class="overflow-x-auto">
    <div class="mb-4" id="overallAccBox" style="display:none;">
      <span id="overallAcc" class="inline-block bg-emerald-600 text-white text-sm px-3 py-1 rounded-full">
        ç¸½è¾¨è­˜ç‡ï¼š--
      </span>
    </div>
    <table class="w-full border border-gray-300 text-center text-base" id="fileTable">
      <thead class="bg-gray-100">
        <tr>
          <th class="border px-4 py-2">æª”æ¡ˆåç¨±</th>
          <th class="border px-4 py-2">æ—¥æœŸ</th>
          <th class="border px-4 py-2">è¾¨è­˜ç‡</th>
          <th class="border px-4 py-2">æ“ä½œ</th>
          <th class="border px-4 py-2">é è¦½</th>
        </tr>
      </thead>
      <tbody id="fileTableBody">
        {% for row in results %}
        <tr>
          <td class="border px-4 py-2">{{ row.origin }}</td>
          <td class="border px-4 py-2">{{ row.date }}</td>
          <td class="border px-4 py-2">
            {% if row.score %}
              {{ (row.score.values()|sum / (row.score.values()|length) * 100) | round(0) }}%
            {% else %}
              0%
            {% endif %}
          </td>
          <td class="border px-4 py-2">
            <a href="{{ url_for('yr_result', filename=row.filename) }}" class="text-blue-600 underline">è©³ç´°</a>
          </td>
          <td class="border px-4 py-2">
            <img src="{{ row.imageUrl }}" alt="é è¦½" class="h-12 rounded border" />
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="mt-6 flex justify-end gap-4">
    <a href="/" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded text-base">å›é¦–é </a>
    <button id="btnClearAll" onclick="clearAllFiles()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded text-base">å…¨éƒ¨æ¸…é™¤</button>
    <button id="btnStart" onclick="submitFiles()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded text-base font-semibold">é–‹å§‹è¾¨è­˜</button>
  </div>

  <!-- é€²åº¦æ¢å€å¡Š -->
  <div class="mt-4 p-3 border rounded bg-gray-50">
    <div class="w-full bg-gray-200 rounded h-3 overflow-hidden">
      <div id="progressBar" class="bg-blue-600 h-3 transition-all duration-300" style="width:0%"></div>
    </div>
    <div class="mt-2 text-sm text-gray-700 flex items-center gap-3">
      <span id="progressStatus">ç­‰å¾…é–‹å§‹â€¦</span>
      <span id="progressCounter" class="px-2 py-0.5 rounded bg-blue-100 text-blue-700">0 / 0</span>
      <span id="progressPercent" class="px-2 py-0.5 rounded bg-gray-100 text-gray-700">0%</span>
    </div>
  </div>

  <div id="pagination" class="mt-4 flex justify-center space-x-2"></div>
</div>

<!-- è¾¨è­˜çµæœå½ˆçª— -->
<div id="resultModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-lg shadow-xl w-[95%] max-w-[95%] max-h-[90vh] p-6 overflow-x-auto overflow-y-auto relative">
    <div class="mb-4" id="modalOverallAccBox" style="display:none;">
      <span id="modalOverallAcc" class="inline-block bg-emerald-600 text-white text-sm px-3 py-1 rounded-full">
        ç¸½è¾¨è­˜ç‡ï¼š--
      </span>
    </div>
    <h2 class="text-3xl font-bold mb-4"><i class="fas fa-edit mr-2"></i> è¾¨è­˜çµæœç·¨è¼¯</h2>
    <table class="w-full border border-gray-300 text-center text-base min-w-max">
      <thead class="bg-gray-100">
        <tr>
          <th class="border px-4 py-2">åœ–ç‰‡æª”å</th>
          <th class="border px-4 py-2">ç™¼ç¥¨è™Ÿç¢¼</th>
          <th class="border px-4 py-2">çµ±ä¸€ç·¨è™Ÿ</th>
          <th class="border px-4 py-2">æ—¥æœŸ</th>
          <th class="border px-4 py-2">åƒ¹æ ¼</th>
          <th class="border px-4 py-2">è³£æ–¹ç·¨è™Ÿ</th>
          <th class="border px-4 py-2">å…¬å¸åç¨±</th>
          <th class="border px-4 py-2">å…¬å¸åœ°å€</th>
          <th class="border px-4 py-2">è¾¨è­˜ç‡</th>
          <th class="border px-4 py-2">é è¦½</th>
        </tr>
        <tr>
          <input id="fStart" type="text">     <!-- èµ·å§‹æ—¥æœŸ -->
          <input id="fEnd"   type="text">     <!-- çµæŸæ—¥æœŸ -->
          <input id="fNum"   type="text">     <!-- ç™¼ç¥¨è™Ÿç¢¼åŒ…å« -->
          <input id="fSun"   type="text">     <!-- çµ±ä¸€ç·¨è™ŸåŒ…å« -->
          <input id="fCashMin" type="number">
          <input id="fCashMax" type="number">
        </tr>
      </thead>
      <tbody id="modalResultsBody"></tbody>
    </table>
    <div class="mt-6 flex justify-end space-x-3">
      <button id="reRecognizeBtn" class="bg-gray-300 hover:bg-gray-400 px-5 py-2 rounded text-base">é‡æ–°è¾¨è­˜</button>
      <button id="downloadBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-5 py-2 rounded text-base">ä¸‹è¼‰ CSV</button>
      <button id="confirmBtn" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded text-base">ç¢ºèªå„²å­˜</button>
      <button id="closeModalBtn" class="absolute top-4 right-4 text-3xl text-gray-600 hover:text-gray-900">&times;</button>
    </div>
  </div>
</div>

<!-- åœ–ç‰‡é è¦½ -->
<div id="imagePreviewModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white p-4 rounded shadow-lg relative max-w-4xl w-full">
    <button onclick="closeImagePreview()" class="absolute top-2 right-3 text-3xl font-bold text-gray-600 hover:text-black">&times;</button>
    <img id="previewImage" src="" alt="é è¦½åœ–ç‰‡" class="mx-auto max-h-[80vh] object-contain" />
  </div>
</div>

<!-- === Save Picker Modal (auto_inv.html) === -->
<div id="filterPicker" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-xl w-[520px] p-6 shadow-xl" onclick="event.stopPropagation()">
    <div class="text-lg font-semibold mb-4">é¸æ“‡è¦å„²å­˜çš„æ¢ä»¶</div>

    <!-- æ—¥æœŸå€é–“ -->
    <div class="mb-4">
      <div class="text-sm font-medium mb-1">æ—¥æœŸï¼ˆå«èµ·è¨–ï¼‰</div>
      <div class="grid grid-cols-2 gap-2">
        <input id="fpDateStart" type="date" class="border rounded px-2 py-1">
        <input id="fpDateEnd"   type="date" class="border rounded px-2 py-1">
      </div>
      <div class="text-xs text-gray-500 mt-1">å¯ç•™ç©ºï¼›ç³»çµ±æœƒç”¨æ¯å¼µç™¼ç¥¨ä¸Šçš„ date å€¼æ¯”å°ã€‚</div>
    </div>

    <!-- æ–‡å­—æ¢ä»¶ -->
    <div class="grid grid-cols-2 gap-4 mb-4">
      <div>
        <div class="text-sm font-medium mb-1">ç™¼ç¥¨è™Ÿç¢¼ï¼ˆnumï¼‰</div>
        <input id="fpNum" type="text" class="w-full border rounded px-2 py-1" placeholder="ä¾‹å¦‚ï¼šAB12345678ï¼ˆå¯éƒ¨åˆ†æ¯”å°ï¼‰">
      </div>
      <div>
        <div class="text-sm font-medium mb-1">çµ±ä¸€ç·¨è™Ÿï¼ˆsunï¼‰</div>
        <input id="fpSun" type="text" class="w-full border rounded px-2 py-1" placeholder="ä¾‹å¦‚ï¼š83521473ï¼ˆå¯éƒ¨åˆ†æ¯”å°ï¼‰">
      </div>
    </div>

    <!-- é‡‘é¡å€é–“ -->
    <div class="grid grid-cols-2 gap-4 mb-4">
      <div>
        <div class="text-sm font-medium mb-1">é‡‘é¡ä¸‹é™ï¼ˆcash â‰¥ï¼‰</div>
        <input id="fpCashMin" type="number" step="1" class="w-full border rounded px-2 py-1" placeholder="ç•™ç©ºä¸è¨­ä¸‹é™">
      </div>
      <div>
        <div class="text-sm font-medium mb-1">é‡‘é¡ä¸Šé™ï¼ˆcash â‰¤ï¼‰</div>
        <input id="fpCashMax" type="number" step="1" class="w-full border rounded px-2 py-1" placeholder="ç•™ç©ºä¸è¨­ä¸Šé™">
      </div>
    </div>
    <!-- å…¬å¸åç¨± -->
    <div class="col-span-2">
      <div class="text-sm font-medium mb-1">å…¬å¸åç¨±ï¼ˆnameï¼‰</div>
      <div class="relative">
        <input id="fpName" type="text" class="w-full border rounded px-2 py-1" placeholder="è¼¸å…¥å…¬å¸é—œéµå­—..." autocomplete="off" />
        <ul id="fpNameSuggest" class="absolute left-0 right-0 bg-white border rounded shadow z-10 mt-1 hidden"></ul>
      </div>
    </div>
    <!-- å‹•ä½œ -->
    <div class="flex justify-end gap-2">
      <button id="fpCancel" class="px-4 py-2 rounded bg-gray-200" type="button">å–æ¶ˆ</button>
      <button id="fpOk"     class="px-4 py-2 rounded bg-blue-600 text-white" type="button">ç¢ºå®š</button>
    </div>
  </div>
</div>
<!-- === /Filter Picker Modal === -->

<script>

// å¾Œç«¯ Jinja2 å‚³ä¾†çš„ results
window.jinjaResults = {{ results|tojson|safe }};

document.addEventListener('DOMContentLoaded', () => {
  const params = new URLSearchParams(window.location.search);
  // å¦‚æœæ˜¯ open=resultsï¼Œä¸” jinjaResults æœ‰è³‡æ–™ï¼Œç›´æ¥é¡¯ç¤ºå½ˆçª—
  if (params.get('open') === 'results' && window.jinjaResults && window.jinjaResults.length > 0) {
    recognizedResults = window.jinjaResults;
    showRecognizeResults(recognizedResults);
  }
});
  function keepAlnum(s){ return String(s||'').replace(/[^A-Za-z0-9]/g,''); }
  function keepDigits(s){ return String(s||'').replace(/\D/g,''); }
  function keepNumber(s){
    let t = String(s||'').replace(/[^0-9.]/g,''); const i = t.indexOf('.');
    if (i !== -1) t = t.slice(0,i+1) + t.slice(i+1).replace(/\./g,''); return t;
  }
  function sanitizeRow(row){
      const r = { ...row };
      if (!r.sun)   r.sun   = r.snu   || '';
      if (!r.snu)   r.snu   = r.sun   || '';
      if (!r.cash)  r.cash  = r.price || '';
      if (!r.price) r.price = r.cash  || '';
      if (!r.num)   r.num   = r.number|| '';
      return r;
    }

  /* ===================== ç‹€æ…‹å…ƒç´  ===================== */
  const fileTableBody    = document.getElementById('fileTableBody');
  const modalResultsBody = document.getElementById('modalResultsBody');
  const resultModal      = document.getElementById('resultModal');

  const btnPickFiles  = document.getElementById('btnPickFiles');
  const btnPickFolder = document.getElementById('btnPickFolder');
  const btnClearAll   = document.getElementById('btnClearAll');
  const btnStart      = document.getElementById('btnStart');

  const progressBar     = document.getElementById('progressBar');
  const progressStatus  = document.getElementById('progressStatus');
  const progressCounter = document.getElementById('progressCounter');
  const progressPercent = document.getElementById('progressPercent');

  let selectedFiles = [];
  let recognizedResults = [];
  try { recognizedResults = JSON.parse(localStorage.getItem('recognizedResults') || '[]'); } catch { recognizedResults = []; }

  /* ===================== é€²åº¦æ¢ / è¼ªè©¢ ===================== */
  let pollTimer = null;
  function setProgress(done, total, finished, error) {
    const percent = (!total || total === 0) ? 0 : Math.floor(done * 100 / total);
    progressBar.style.width = percent + '%';
    progressCounter.textContent = `${done} / ${total}`;
    progressPercent.textContent = percent + '%';
    if (error) {
      progressStatus.textContent = `è™•ç†å®Œæˆï¼ˆæœ‰éŒ¯èª¤ï¼‰ï¼š${error}`;
    } else if (finished) {
      progressStatus.textContent = 'è™•ç†å®Œæˆ âœ…';
    } else if (total > 0) {
      progressStatus.textContent = 'è¾¨è­˜ä¸­â€¦';
    } else {
      progressStatus.textContent = 'é–‹å§‹è¾¨è­˜ä¸­â€¦';
    }
  }
  function disableActions(disabled) {
    [btnPickFiles, btnPickFolder, btnClearAll, btnStart].forEach(b => b.disabled = !!disabled);
    [btnPickFiles, btnPickFolder, btnClearAll, btnStart].forEach(b => {
      b.classList.toggle('opacity-50', !!disabled);
      b.classList.toggle('cursor-not-allowed', !!disabled);
    });
  }
  function startProgressPolling(jobId) {
    // å…ˆæ­¸é›¶ï¼Œç­‰å¾…å¾Œç«¯ç¬¬ä¸€æ¬¡å›å ± total
    setProgress(0, 0, false, '');
    if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
    pollTimer = setInterval(async () => {
      try {
        const r = await fetch(`/progress/${jobId}`, { cache: 'no-store' });
        if (!r.ok) return;
        const p = await r.json();
        setProgress(p.done || 0, p.total || 0, !!p.finished, p.error || '');
        if (p.finished) {
          clearInterval(pollTimer); pollTimer = null;
          disableActions(false);
        }
      } catch (e) {}
    }, 500);
  }

  /* ===================== æª”æ¡ˆæ¸…å–®ï¼ˆå«åˆ†é ï¼‰ ===================== */
  let currentPage = 1;
  const rowsPerPage = 10;

  function renderFileTable() {
    fileTableBody.innerHTML = '';
    const today = new Date().toISOString().split('T')[0];

    const start = (currentPage - 1) * rowsPerPage;
    const end   = start + rowsPerPage;
    const pageFiles = selectedFiles.slice(start, end);

    let accSum = 0, accCount = 0;
    let hasResults = recognizedResults && recognizedResults.length > 0;
    const keys = ['num', 'date', 'sun', 'cash'];
    pageFiles.forEach(function(file, idx) {
      var score = '';
      var date = '';
      var name = file.name || file;
      if (hasResults && recognizedResults[start + idx]) {
        const scoreObj = recognizedResults[start + idx].score;
        let vals = [];
        if (scoreObj && typeof scoreObj === 'object') {
          // åªç”¨ YOLO confï¼Œä¸æ··ç”¨ OCR
          vals = keys.map(k => typeof scoreObj[k] === 'number' ? scoreObj[k] : 0);
        }
        let avgScore = vals.length > 0 ? vals.reduce((a,b)=>a+b,0) / vals.length : 0;
        score = Math.round(avgScore * 100) + '%';
        date = recognizedResults[start + idx].date || '';
        accSum += avgScore; accCount++;
      } else {
        date = '';
        score = '';
      }
      fileTableBody.innerHTML +=
        '<tr>' +
          '<td class="border px-4 py-2">' + name + '</td>' +
          '<td class="border px-4 py-2">' + date + '</td>' +
          '<td class="border px-4 py-2">' + (hasResults ? score : '') + '</td>' +
          '<td class="border px-4 py-2 space-x-2">' +
            '<label class="bg-yellow-400 hover:bg-yellow-500 text-white text-sm px-2 py-1 rounded cursor-pointer">' +
              'ä¿®æ”¹<input type="file" accept="image/*" class="hidden" onchange="replaceFile(event,' + (start + idx) + ')" />' +
            '</label>' +
            '<button onclick="removeFile(' + (start + idx) + ')" class="bg-red-400 hover:bg-red-500 text-white text-sm px-2 py-1 rounded">åˆªé™¤</button>' +
          '</td>' +
          '<td class="border px-4 py-2">' +
            '<button onclick="previewFile(' + (start + idx) + ')" class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-3 py-1 rounded">é è¦½</button>' +
          '</td>' +
        '</tr>';
    });
    // è¾¨è­˜å¾Œæ‰é¡¯ç¤ºç¸½è¾¨è­˜ç‡ï¼ˆåªå– num/date/sun/cash å››æ¬„å¹³å‡ï¼‰
    const overallBox = document.getElementById('overallAccBox');
    if (hasResults && accCount > 0) {
      const overall = Math.round(100 * accSum / accCount);
      document.getElementById('overallAcc').textContent = `ç¸½è¾¨è­˜ç‡ï¼š${overall}%`;
      overallBox.style.display = '';
    } else {
      document.getElementById('overallAcc').textContent = '';
      overallBox.style.display = 'none';
    }
    renderPagination();
  }
  function renderPagination() {
    const pageCount = Math.ceil(selectedFiles.length / rowsPerPage);
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';
    for (let i = 1; i <= pageCount; i++) {
      pagination.innerHTML += `
        <button onclick="changePage(${i})" class="${i === currentPage ? 'bg-blue-600 text-white' : 'bg-gray-200'} px-3 py-1 rounded">
          ${i}
        </button>`;
    }
  }
  function changePage(p) { currentPage = p; renderFileTable(); }
  function replaceFile(e, idx) { if (e.target.files[0]) { selectedFiles[idx] = e.target.files[0]; renderFileTable(); } }
  function removeFile(idx) {
    selectedFiles.splice(idx, 1);
    const maxPage = Math.max(1, Math.ceil(selectedFiles.length / rowsPerPage));
    if (currentPage > maxPage) currentPage = maxPage;
    renderFileTable();
  }
  function handleFiles(fileList) { selectedFiles = selectedFiles.concat(Array.from(fileList)); renderFileTable(); }
  document.getElementById('filePicker').onchange  = function () { handleFiles(this.files); };
  document.getElementById('folderPicker').onchange = function () { handleFiles(this.files); };

  function clearAllFiles() {
    selectedFiles = [];
    recognizedResults = [];
    document.getElementById('filePicker').value = '';
    document.getElementById('folderPicker').value = '';
    currentPage = 1;
    renderFileTable();
    closeModal();
    setProgress(0, 0, false, '');
    try { localStorage.removeItem('recognizedResults'); } catch {}
  }

  /* ===================== ä¸Šå‚³ä¸¦è¾¨è­˜ ===================== */
  async function submitFiles() {
    if (selectedFiles.length === 0) {
      alert('è«‹å…ˆé¸æ“‡æª”æ¡ˆ');
      return;
    }

    disableActions(true);

    const formData = new FormData();
    selectedFiles.forEach((file) => formData.append('files', file));

    const jobId = crypto.randomUUID();
    formData.append('job_id', jobId);
    startProgressPolling(jobId);

    try {
      const response = await fetch('/upload', { method: 'POST', body: formData });
      const payload  = await response.json().catch(() => ({}));

      if (!response.ok) {
        setProgress(0, selectedFiles.length || 0, true, payload.error || response.statusText);
        disableActions(false);
        alert('ä¸Šå‚³å¤±æ•—: ' + (payload.error || response.statusText));
        return;
      }

      // âœ… æˆåŠŸï¼šé¡¯ç¤ºã€Œè¾¨è­˜çµæœç·¨è¼¯ã€å½ˆçª—ï¼ˆä¸è‡ªå‹•è·³ result.htmlï¼‰
      let results = payload.results || payload;
      if (!Array.isArray(results) || results.length === 0) {
        setProgress(selectedFiles.length || 0, selectedFiles.length || 0, true, '');
        disableActions(false);
        alert('æ²’æœ‰è¾¨è­˜çµæœ');
        return;
      }

      recognizedResults = results.map(sanitizeRow);
      try { localStorage.setItem('recognizedResults', JSON.stringify(recognizedResults)); } catch {}
      showRecognizeResults(recognizedResults);

      setProgress(selectedFiles.length || recognizedResults.length,
                  selectedFiles.length || recognizedResults.length,
                  true, '');
      disableActions(false);
    } catch (err) {
      setProgress(0, selectedFiles.length || 0, true, err.message || 'æœªçŸ¥éŒ¯èª¤');
      disableActions(false);
      alert('ç™¼ç”ŸéŒ¯èª¤: ' + (err.message || err));
    }
  }


  /* ===================== é¡¯ç¤ºçµæœï¼ˆDOM APIï¼‰ ===================== */
  function showRecognizeResults(results) {
    const tbody = document.getElementById('modalResultsBody');
    if (!tbody) return;
    tbody.innerHTML = '';

    let accSum = 0, accCount = 0;
    const keys = ['num', 'date', 'sun', 'cash'];
    (results || []).forEach(function(r, idx) {
      r = sanitizeRow(r);
      var filename    = r.filename || (r.imageUrl ? r.imageUrl.split('/').pop() : 'image_' + (idx+1) + '.jpg');
      var displayName = r.origin || filename;
      // è¾¨è­˜ç‡åªå–å››æ¬„å¹³å‡
      let vals = [];
      if (r.score && typeof r.score === 'object') {
        // åªç”¨ YOLO confï¼Œä¸æ··ç”¨ OCR
        vals = keys.map(k => typeof r.score[k] === 'number' ? r.score[k] : 0);
      }
      let avgScore = vals.length > 0 ? vals.reduce((a,b)=>a+b,0) / vals.length : 0;
      var score = Math.round(avgScore * 100) + '%';
      accSum += avgScore; accCount++;

      var tr = document.createElement('tr');
      // æª”å
      var tdText = function(text) { var td=document.createElement('td'); td.className='border px-4 py-2'; td.textContent=text||''; return td; };
      var tdInput = function(key, clean) {
        var td = document.createElement('td');
        td.className = 'border px-4 py-2';
        td.setAttribute('data-key', key);
        var input = document.createElement('input');
        input.type = 'text';
        input.className = 'w-full text-center';
        input.value = r[key] || '';
        input.oninput = function() {
          var v = input.value;
          if (clean === 'alnum')  v = keepAlnum(v).slice(0, 14);
          if (clean === 'digits') v = keepDigits(v).slice(0, 8);
          if (clean === 'money')  v = keepNumber(v);
          input.value = v;
        };
        input.onchange = function() {
          r[key] = input.value;
          recognizedResults[idx] = sanitizeRow(r);
          cacheResults();
        };
        input.setAttribute('data-key', key);
        td.appendChild(input);
        return td;
      };
      tr.dataset.filename = filename;
      tr.dataset.imageUrl = r.imageUrl || '';
      tr.appendChild(tdText(displayName));
      tr.appendChild(tdInput('num','alnum'));
      tr.appendChild(tdInput('sun','digits'));
      tr.appendChild(tdInput('date'));
      tr.appendChild(tdInput('cash','money'));
      tr.appendChild(tdInput('bnu','digits'));
      tr.appendChild(tdInput('name'));
      tr.appendChild(tdInput('add'));
      // è¾¨è­˜ç‡ï¼ˆè¾¨è­˜å‰ä¸é¡¯ç¤ºï¼‰
      var tdScore = document.createElement('td');
      tdScore.className = 'border px-4 py-2';
      tdScore.textContent = (avgScore > 0 ? score : '');
      tr.appendChild(tdScore);
      // é è¦½
      var tdPreview = document.createElement('td');
      tdPreview.className = 'border px-4 py-2';
  var a = document.createElement('a');
  a.href = '/result/' + filename;
  a.className = 'bg-purple-600 hover:bg-purple-700 text-white text-sm px-2 py-1 rounded';
  a.textContent = 'è©³ç´°é è¦½';
  tdPreview.appendChild(a);
  tr.appendChild(tdPreview);
      tbody.appendChild(tr);
    });
    // é¡¯ç¤ºç¸½è¾¨è­˜ç‡
    var overall = accCount ? Math.round(100 * accSum / accCount) : 0;
    document.getElementById('modalOverallAcc').textContent = 'ç¸½è¾¨è­˜ç‡ï¼š' + overall + '%';
    document.getElementById('modalOverallAccBox').style.display = '';
    document.getElementById('resultModal').classList.remove('hidden');
  }

  function cacheResults() {
    try { localStorage.setItem('recognizedResults', JSON.stringify(recognizedResults)); } catch {}
  }

  function closeModal() { resultModal.classList.add('hidden'); }
  document.getElementById('closeModalBtn').onclick = closeModal;

  // é‡æ–°è¾¨è­˜ï¼šæœ‰æª”æ¡ˆå°±ç›´æ¥å†é€ä¸€æ¬¡
  document.getElementById('reRecognizeBtn').onclick = () => {
    if (!selectedFiles.length) { alert('æ²’æœ‰å¯é‡æ–°è¾¨è­˜çš„æª”æ¡ˆ'); return; }
    submitFiles();
  };

  /* ===================== ä¸‹è¼‰ CSV ===================== */
  document.getElementById('downloadBtn').onclick = () => {
    if (!recognizedResults || !recognizedResults.length) { alert('ç„¡è¾¨è­˜çµæœå¯ä¸‹è¼‰'); return; }
    const rows = [['ç™¼ç¥¨è™Ÿç¢¼','çµ±ä¸€ç·¨è™Ÿ','æ—¥æœŸ','åƒ¹æ ¼','è³£æ–¹ç·¨è™Ÿ','å…¬å¸åç¨±','å…¬å¸åœ°å€']];
    recognizedResults.forEach(r => {
      r = sanitizeRow(r);
      rows.push([r.num||'', r.sun||'', r.date||'', (r.cash||''), r.bnu||'', r.name||'', r.add||'']);
    });
    const csv = rows.map(r => r.join(',')).join('\n');
    const blob = new Blob(["\uFEFF"+csv], {type: "text/csv;charset=utf-8;"});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='è¾¨è­˜çµæœ.csv';
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
  };

  /* ===================== ç¢ºèªå„²å­˜ ===================== */

  /* ===================== åœ–ç‰‡é è¦½ ===================== */
  function previewFile(idx){
    const src = URL.createObjectURL(selectedFiles[idx]);
    if (!src) return alert('æ‰¾ä¸åˆ°åœ–ç‰‡æˆ–è·¯å¾‘éŒ¯èª¤');
    const modal = document.getElementById("imagePreviewModal");
    const img   = document.getElementById("previewImage");
    img.src = src; modal.classList.remove("hidden");
  }
  function closeImagePreview() {
    const modal = document.getElementById("imagePreviewModal");
    const img   = document.getElementById("previewImage");
    img.src = ""; modal.classList.add("hidden");
  }


  // å·¥å…·ï¼šæŠŠå­—ä¸²è½‰ YYYY-MM-DDï¼ˆå¯åƒ 2025/07/09ã€2025-7-9â€¦ï¼‰
  function toYMD(s){
    if (!s) return '';
    const d = String(s).trim().replace(/[^\d]/g,'');   // 2025/07/09 -> 20250709
    if (d.length !== 8) return '';
    return `${d.slice(0,4)}-${d.slice(4,6)}-${d.slice(6)}`;   // â† ä¸è¦æ›è¡Œï¼
  }
  function toInt(n){ const v = String(n||'').replace(/[^\d\-]/g,''); return v===''?null:parseInt(v,10); }

  function contains(hay, needle){
    hay = String(hay||'').toLowerCase();
    needle = String(needle||'').toLowerCase().trim();
    return !needle || hay.includes(needle);
  }
  // å–å¾—ç›®å‰ç•«é¢ä¸Šçš„çµæœé™£åˆ—ï¼ˆauto_inv.html å·²æœ‰ recognizedResultsï¼‰
  function getAllRowsForSave(){
    const rows = [];
    document.querySelectorAll('#modalResultsBody tr').forEach(tr=>{
      const get = k => (tr.querySelector(`input[data-key="${k}"]`)?.value || '').trim();
      rows.push({
        num:   get('num'),
        sun:   get('sun'),
        date:  get('date'),
        cash:  get('cash'),
        name:  get('name'),
        add:   get('add'),
        // èˆŠæ¬„ä½ç›¸å®¹
        snu:   get('sun'),
        price: get('cash'),
        // æª”å/è·¯å¾‘ï¼ˆåœ¨æ¸²æŸ“åˆ—æ™‚å·²å¡åˆ° dataset äº†ï¼‰
        filename: tr.dataset.filename || '',
        imageUrl: tr.dataset.imageUrl || '',
        path:     tr.dataset.filename || ''
      });
    });
    return rows;
  }


  // ä¾æ¢ä»¶éæ¿¾
  function filterRows(rows, cond){
    const s = toYMD(cond.dateStart);
    const e = toYMD(cond.dateEnd);
    const n = (cond.num||'').trim();
    const u = (cond.sun||'').trim();
    const min = toInt(cond.cashMin);
    const max = toInt(cond.cashMax);

    return rows.filter(r=>{
      // æ—¥æœŸ
      if (s || e){
        const d = toYMD(r.date);
        if (!d) return false;
        if (s && d < s) return false;
        if (e && d > e) return false;
      }
      // ç™¼ç¥¨è™Ÿç¢¼ / çµ±ç·¨
      if (n && !String(r.num).includes(n)) return false;
      if (u && !String(r.sun).includes(u)) return false;
      // å…¬å¸åç¨±
      if (cond.name && !String(r.name||'').toLowerCase().includes(cond.name.toLowerCase())) return false;
      // é‡‘é¡
      const c = toInt(r.cash);
      if (min!=null && (c==null || c < min)) return false;
      if (max!=null && (c==null || c > max)) return false;
      return true;
    });
  }

  // é–‹é—œ modal
  function openFilterPicker(){
    const box = document.getElementById('filterPicker');
    box.classList.remove('hidden');
    box.classList.add('flex');
  }
  function closeFilterPicker(){
    const box = document.getElementById('filterPicker');
    box.classList.add('hidden');
    box.classList.remove('flex');
  }
  document.getElementById('filterPicker')?.addEventListener('click', closeFilterPicker);
  document.getElementById('fpCancel')?.addEventListener('click', closeFilterPicker);

 // ã€Œç¢ºèªå„²å­˜ã€â†’ é–‹å•Ÿç¯©é¸å½ˆçª—
  document.getElementById('confirmBtn')?.addEventListener('click', ()=>{
    openFilterPicker(); // ä½ é é¢å·²æœ‰é€™å€‹å‡½å¼
  });

  // ã€Œå¥—ç”¨å„²å­˜ã€â†’ ä¾æ¢ä»¶éæ¿¾ â†’ å‘¼å« /confirm_result
  document.getElementById('fpOk').addEventListener('click', async ()=>{
    const cond = getFilterCond();
    const all  = getAllRowsForSave();
    const rows = filterRows(all, cond);
    if (!rows.length) { alert('æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„ç™¼ç¥¨'); return; }

    try{
      const rsp = await fetch('/confirm_result',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ items: rows })
      });
      const data = await rsp.json().catch(()=>({}));
      if (!rsp.ok) throw new Error(data.error || rsp.statusText);
      alert(`å·²å„²å­˜ ${data.saved||0} ç­†ï¼ˆç•¥é ${data.skipped||0}ï¼‰`);
      closeFilterPicker();
    }catch(err){
      alert('å„²å­˜å¤±æ•—ï¼š' + (err.message||err));
    }
  });



    // âœ… ç”¢ç”Ÿå¸¶ data-key çš„æ¬„ä½ï¼Œè®“å¾ŒçºŒèƒ½å–å€¼
  const tdInput = (r, idx, key, clean) => {
    const td = document.createElement('td');
    td.className = 'border px-4 py-2';
    td.setAttribute('data-key', key);      // â˜… æ–°å¢
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'w-full text-center';
    input.value = r[key] ?? '';
    input.setAttribute('data-key', key);   // â˜… æ–°å¢
    input.oninput = () => {
      let v = input.value;
      if (clean === 'alnum')  v = v.replace(/[^A-Za-z0-9]/g,'').slice(0,14);
      if (clean === 'digits') v = v.replace(/\D/g,'').slice(0,8);
      if (clean === 'money')  v = v.replace(/[^\d]/g,'');
      input.value = v;
    };
    input.onchange = () => {
      r[key] = input.value;
      recognizedResults[idx] = r;
      cacheResults && cacheResults();
    };
    td.appendChild(input);
    return td;
  };

  function addRowToTbody(tbody, r, idx) {
    const tr = document.createElement('tr');
    // â˜… æŠŠæª”åèˆ‡å½±åƒè·¯å¾‘å¡åˆ° datasetï¼Œå¾Œé¢é€å­˜ç”¨å¾—åˆ°
    tr.dataset.filename = r.filename || r.path || '';
    tr.dataset.imageUrl = r.imageUrl || '';

    // ä¾åº append å„æ¬„ä½ï¼ˆèˆ‰ä¾‹ï¼‰
    tr.appendChild(tdInput(r, idx, 'num',  'alnum'));
    tr.appendChild(tdInput(r, idx, 'sun',  'digits'));
    tr.appendChild(tdInput(r, idx, 'date', 'digits'));
    tr.appendChild(tdInput(r, idx, 'cash', 'money'));
    tr.appendChild(tdInput(r, idx, 'name', null));   // â† å…¬å¸åç¨±ä¹Ÿè¦æœ‰ data-key
    tr.appendChild(tdInput(r, idx, 'add',  null));
    // â€¦æœ‰å…¶ä»–æ¬„ä½ç…§æ¨£åŠ â€¦

    tbody.appendChild(tr);
  }

  function getFilterCond(){
    return {
      dateStart: document.getElementById('fpDateStart').value,
      dateEnd:   document.getElementById('fpDateEnd').value,
      num:       document.getElementById('fpNum').value,
      sun:       document.getElementById('fpSun').value,
      cashMin:   document.getElementById('fpCashMin').value,
      cashMax:   document.getElementById('fpCashMax').value,
      name:      document.getElementById('fpName').value,
    };
  }

// å°å·¥å…·
const $  = (s) => document.querySelector(s);
const $$ = (s) => Array.from(document.querySelectorAll(s));

// ä¸€åˆ—è½‰ç‰©ä»¶ï¼šä¾ä½ è¡¨é ­é †åºï¼šæª”å, ç™¼ç¥¨è™Ÿç¢¼, çµ±ä¸€ç·¨è™Ÿ, æ—¥æœŸ, åƒ¹æ ¼, è²·æ–¹ç·¨è™Ÿ, å…¬å¸åç¨±, å…¬å¸åœ°å€
function rowToItem(tr) {
  const t = tr.children;
  return {
    num: (t[1]?.textContent || '').trim(),
    sun: (t[2]?.textContent || '').trim(),
    date: (t[3]?.textContent || '').trim(),                 // å…è¨± 2025/07/09 æˆ– 2025-07-09
    cash: Number((t[4]?.textContent || '0').replace(/[, ]/g,'')) || 0,
    company_name: (t[6]?.textContent || '').trim()
  };
}

// ä¾å½ˆçª—æ¢ä»¶éæ¿¾
function matchFilters(it) {
  const s   = ($('#fStart')?.value || '').trim();
  const e   = ($('#fEnd')?.value   || '').trim();
  const num = ($('#fNum')?.value   || '').trim();
  const sun = ($('#fSun')?.value   || '').trim();
  const min = $('#fCashMin')?.value ? Number($('#fCashMin').value) : -Infinity;
  const max = $('#fCashMax')?.value ? Number($('#fCashMax').value) :  Infinity;

  if (s && it.date < s) return false;
  if (e && it.date > e) return false;
  if (num && !it.num.includes(num)) return false;
  if (sun && !it.sun.includes(sun)) return false;
  if (!(it.cash >= min && it.cash <= max)) return false;
  return true;
}

// é€åˆ°å¾Œç«¯
async function saveItem(it) {
  if (!it.num || !it.sun || !it.date || !it.company_name) {
    throw new Error('æœ‰è³‡æ–™ç¼ºå°‘ num / sun / date / å…¬å¸åç¨±');
  }
  const r = await fetch('/confirm_result', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(it)
  });
  const j = await r.json().catch(()=>({}));
  if (!r.ok || j.ok === false) throw new Error(j.message || (r.status+' '+r.statusText));
  return j;
}

// é»ã€Œç¢ºå®šã€â†’ å¾è¡¨æ ¼æŠ“è³‡æ–™ â†’ å¥—ç¯©é¸ â†’ é€ç­†å„²å­˜
$('#saveConfirm')?.addEventListener('click', async () => {
  try {
    const rows = $$('#editTable tbody tr');
    const list = rows.map(rowToItem).filter(matchFilters);
    if (!list.length) return alert('æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³‡æ–™');

    let ok = 0;
    for (const it of list) { await saveItem(it); ok++; }
    alert(`å·²å„²å­˜ ${ok} ç­†`);
  } catch (e) { alert('å„²å­˜å¤±æ•—ï¼š' + e.message); }
});
// å…¬å¸åç¨±è‡ªå‹•å®Œæˆï¼ˆautocompleteï¼‰
document.addEventListener('DOMContentLoaded', () => {
  const nameInput = document.getElementById('fpName');
  const suggestBox = document.getElementById('fpNameSuggest');
  function getAllNames() {
    const names = new Set();
    (recognizedResults || []).forEach(r => {
      if (r.name) names.add(r.name.trim());
    });
    return Array.from(names).filter(n => n);
  }
  function showSuggest(keyword) {
    const all = getAllNames();
    const list = all.filter(n => n.toLowerCase().includes(keyword.toLowerCase()));
    if (!keyword || list.length === 0) { suggestBox.innerHTML = ''; suggestBox.classList.add('hidden'); return; }
    suggestBox.innerHTML = list.map(n => `<li class="px-3 py-2 cursor-pointer hover:bg-blue-100">${n}</li>`).join('');
    suggestBox.classList.remove('hidden');
    suggestBox.style.position = 'absolute';
    suggestBox.style.zIndex = '100';
    suggestBox.querySelectorAll('li').forEach(li => {
      li.addEventListener('mousedown', e => {
        nameInput.value = li.textContent;
        suggestBox.classList.add('hidden');
      });
    });
  }
  nameInput.addEventListener('input', e => {
    showSuggest(nameInput.value);
  });
  nameInput.addEventListener('focus', e => {
    showSuggest(nameInput.value);
  });
  nameInput.addEventListener('blur', () => {
    setTimeout(() => suggestBox.classList.add('hidden'), 200);
  });
});
</script>

{% endblock %}
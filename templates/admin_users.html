{% extends "base.html" %}
{% block title %}使用者管理 - fastB2B{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto py-10 px-4">
  <h2 class="text-4xl font-extrabold text-blue-700 mb-8 flex items-center drop-shadow">
    <i class="fas fa-users-cog mr-3 text-4xl"></i> 使用者管理
  </h2>
  <!-- 操作說明色塊 -->
  <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-xl mb-8 shadow flex items-start gap-3 animate__animated animate__fadeIn">
    <i class="fas fa-info-circle text-blue-500 text-2xl mt-1"></i>
    <ul class="list-disc pl-4 text-blue-700 text-base space-y-1">
      <li>可切換使用者角色（管理員/一般），不可修改自己權限。</li>
      <li>刪除使用者前請確認無發票紀錄，自己不可刪除。</li>
      <li>所屬公司、配合公司皆可展開檢視。</li>
      <li>如需匯出使用者清單，請聯絡管理員。</li>
    </ul>
  </div>

  <div class="overflow-x-auto bg-white shadow-lg rounded-xl">
    <table class="min-w-full text-center border border-gray-300 rounded-xl overflow-hidden">
      <thead class="bg-blue-100">
        <tr>
          <th class="border px-4 py-3 font-semibold text-blue-700">帳號</th>
          <th class="border px-4 py-3 font-semibold text-blue-700">角色</th>
          <th class="border px-4 py-3 font-semibold text-blue-700">姓名 / Email</th>
          <th class="border px-4 py-3 font-semibold text-blue-700">所屬公司</th>
          <th class="border px-4 py-3 font-semibold text-blue-700">配合公司（依發票）</th>
          <th class="border px-4 py-3 font-semibold text-blue-700">發票數</th>
          <th class="border px-4 py-3 font-semibold text-blue-700">操作</th>
        </tr>
      </thead>
      <tbody>
        {% if users %}
          {% for u in users %}
          <tr class="hover:bg-blue-50 transition">
            <td class="border px-4 py-2 font-mono">{{ u.us_na }}</td>
            <td class="border px-4 py-3">
              <span class="inline-block px-3 py-1 rounded-full text-white font-semibold {{ 'bg-red-600' if u.role=='admin' else 'bg-gray-600' }}">
                <i class="fas fa-user-shield mr-1"></i> {{ u.role }}
              </span>
            </td>
            <td class="border px-4 py-3">
              <div>{{ u.name or '-' }}</div>
              <div class="text-sm text-gray-500">{{ u.mail or '-' }}</div>
            </td>
            <td class="border px-4 py-3">
              {% if u.owned_companies %}
                <ul class="list-disc list-inside text-left">
                  {% for c in u.owned_companies %}
                    <li>{{ c.co_na or '(未命名)' }} <span class="text-gray-500">({{ c.tax_id or '-' }})</span></li>
                  {% endfor %}
                </ul>
              {% else %}
                <span class="text-gray-400">—</span>
              {% endif %}
            </td>
            <td class="border px-4 py-3">
              {% if u.partner_companies %}
                <ul class="list-disc list-inside text-left max-h-40 overflow-auto">
                  {% for c in u.partner_companies %}
                    <li>{{ c.co_na or '(未命名)' }} <span class="text-gray-500">({{ c.tax_id or '-' }})</span></li>
                  {% endfor %}
                </ul>
              {% else %}
                <span class="text-gray-400">—</span>
              {% endif %}
            </td>
            <td class="border px-4 py-3">{{ u.invoice_count }}</td>

            <td class="border px-4 py-3">
              <div class="flex items-center justify-center gap-3 flex-wrap">
                <!-- 角色切換 -->
                <form method="POST" action="{{ url_for('admin_users_set_role', user_id=u.id) }}"
                      onsubmit="return confirm('確認變更 {{ u.us_na }} 的角色？');">
                  {% if u.role == 'admin' %}
                    <input type="hidden" name="role" value="user">
                    <button class="bg-gradient-to-r from-yellow-400 to-amber-500 hover:from-yellow-500 hover:to-amber-600 text-white px-5 py-2 rounded-xl font-semibold shadow inline-flex items-center transition"
                            {% if session.user_id == u.id %}disabled title="不可修改自己的權限"{% endif %}>
                      <i class="fas fa-user-minus mr-2"></i> 降為一般
                    </button>
                  {% else %}
                    <input type="hidden" name="role" value="admin">
                    <button class="bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-700 hover:to-indigo-800 text-white px-5 py-2 rounded-xl font-semibold shadow inline-flex items-center transition"
                            {% if session.user_id == u.id %}disabled title="不可修改自己的權限"{% endif %}>
                      <i class="fas fa-user-shield mr-2"></i> 升為管理員
                    </button>
                  {% endif %}
                </form>

                <!-- 刪除使用者（有發票則阻擋） -->
                <form method="POST" action="{{ url_for('admin_users_delete', user_id=u.id) }}"
                      onsubmit="return confirm('確定要刪除 {{ u.us_na }} 嗎？此動作無法復原');">
                  <button class="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white px-5 py-2 rounded-xl font-semibold shadow inline-flex items-center transition"
                          {% if session.user_id == u.id %}disabled title="不可刪除自己"{% endif %}>
                    <i class="fas fa-trash-alt mr-2"></i> 刪除
                  </button>
                </form>
              </div>
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="7" class="py-6">
              <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-xl shadow flex items-center gap-3 mb-6">
                <i class="fas fa-exclamation-circle text-yellow-500 text-2xl"></i>
                <span class="text-yellow-700 text-base font-semibold">目前尚無使用者，請由管理員新增。</span>
              </div>
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

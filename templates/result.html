<!DOCTYPE html>
<html lang="zh-TW" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>發票詳細辨識結果 - fastB2B</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    .toast{position:fixed;bottom:1rem;right:1rem;background:#38a169;color:#fff;padding:.75rem 1.25rem;border-radius:.375rem;box-shadow:0 0 10px rgba(0,0,0,.1);z-index:9999;animation:fadeInOut 3s ease-in-out}
    @keyframes fadeInOut{0%{opacity:0;transform:translateY(10px)}10%,90%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(10px)}}
  </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans transition-colors duration-300">

<div class="flex flex-col min-h-screen">
  <!-- 上方工具列 -->
  <div class="flex justify-between items-center p-4 gap-2 bg-blue-50 border-b">
    <div class="text-xl font-bold text-blue-700 flex items-center gap-2">
      <i class="fas fa-receipt"></i> 發票詳細辨識結果
    </div>
    <a href="/invoice/auto?open=results" class="text-sm bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded shadow">↩ 回到辨識結果</a>
  </div>

  <!-- 主內容 -->
  <div class="flex flex-grow h-[calc(100vh-7rem)]">
    <!-- 左：原始圖片 -->
    <div class="w-1/2 bg-white p-8 overflow-auto flex flex-col items-center justify-center border-r">
      <img src="{{ result.imageUrl }}" alt="原始發票圖片"
           class="max-w-full max-h-[80vh] rounded-2xl border-2 border-blue-100 shadow-xl mb-6" />
      <div class="bg-blue-50 rounded-lg px-4 py-2 text-gray-700 text-sm shadow">
        <div><span class="font-bold text-blue-700">檔名：</span>{{ result.filename }}</div>
        <div><span class="font-bold text-blue-700">來源：</span>{{ result.source|default('上傳', true) }}</div>
        <div><span class="font-bold text-blue-700">上傳時間：</span>{{ result.ctime|default('') }}</div>
      </div>
    </div>

    <!-- 右：欄位卡片 -->
    <div class="w-1/2 p-8 bg-gray-50 overflow-y-auto">
      <div class="mb-4 flex gap-4 flex-wrap">
        <span class="inline-block bg-emerald-600 text-white text-base px-4 py-2 rounded-full shadow">
          整體辨識率：
          {% set confs = result.score.values() if result.score else [] %}
          {% if confs %}
            {{ (confs|sum / (confs|length) * 100) | round(0) }}%
          {% else %}
            0%
          {% endif %}
        </span>
        <span class="inline-block bg-gray-200 text-gray-700 text-base px-4 py-2 rounded-full shadow">
          類別辨識率：
          <span class="ml-2">號碼 <span class="font-bold text-blue-700">{{ ((result.score.num or 0) * 100) | round(0) }}%</span></span>
          <span class="ml-2">日期 <span class="font-bold text-blue-700">{{ ((result.score.date or 0) * 100) | round(0) }}%</span></span>
          <span class="ml-2">金額 <span class="font-bold text-blue-700">{{ ((result.score.cash or 0) * 100) | round(0) }}%</span></span>
          <span class="ml-2">統編 <span class="font-bold text-blue-700">{{ ((result.score.sun or 0) * 100) | round(0) }}%</span></span>
        </span>
      </div>
      {% for item in texts %}
      <div class="flex items-start gap-5 bg-white border-2 border-blue-100 rounded-2xl shadow-lg p-5 mb-6">
        <!-- 裁切圖 -->
        <div class="w-40 h-28 border-2 border-gray-200 rounded-lg flex items-center justify-center overflow-hidden bg-gray-50">
          {% if item.cropped_image %}
            <img
              src="{{ url_for('uploads_cropped', filename=item.cropped_image) }}"
              alt="{{ item.label }} 裁切圖"
              class="max-w-full max-h-full object-contain" />
          {% else %}
            <span class="text-gray-400 text-sm">無圖片</span>
          {% endif %}
        </div>

        <!-- 文字欄位 -->
        <div class="flex-1">
          <div class="flex items-center gap-2 mb-2">
            <span class="text-indigo-700 font-bold text-lg">{{ item.label }}</span>
            {% if result.score[item.key] is defined %}
              {% set rate = (result.score[item.key] or 0) * 100 %}
              <span class="px-2 py-1 rounded-full text-xs font-bold"
                style="background:{{ rate >= 80 and '#34d399' or rate >= 50 and '#fde68a' or '#fca5a5' }};color:{{ rate >= 80 and '#fff' or rate >= 50 and '#92400e' or '#991b1b' }};">
                辨識率 {{ rate|round(0) }}%
              </span>
              {% if rate < 60 %}
                <span class="ml-2 text-red-500 text-xs">建議人工修正</span>
              {% endif %}
            {% endif %}
          </div>
          <input
            type="text"
            value="{{ item.text }}"
            data-key="{{ item.key }}"
            class="text-base border-2 border-indigo-200 rounded-lg px-4 py-2 bg-gray-50 w-full focus:outline-none focus:ring-2 focus:ring-indigo-400 font-mono" />
          <div class="text-gray-500 text-xs mt-1">{{ item.desc|default('請確認欄位內容是否正確') }}</div>
        </div>
      </div>
      {% endfor %}
      {% if not texts or texts|length == 0 %}
        <div class="text-center text-gray-400 py-10 text-lg">尚無辨識欄位，請重新辨識或聯絡管理員。</div>
      {% endif %}
    </div>
  </div>

  <!-- 下方操作列 -->
  <div class="bg-white border-t p-7 flex justify-center gap-7 flex-wrap shadow">
    <button type="button" id="csvBtn"
      class="inline-flex items-center bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-full shadow-lg text-lg font-bold">
      <i class="fas fa-file-csv mr-2"></i> 下載 CSV
    </button>

    <button id="confirmBtn"
      class="inline-flex items-center bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-full shadow-lg text-lg font-bold">
      <i class="fas fa-save mr-2"></i> 確認儲存
    </button>
  </div>

  <!-- 常見問題 Q&A -->
  <div class="bg-blue-50 border-t p-8 text-blue-900 text-base mt-2">
    <h3 class="text-xl font-bold mb-3"><i class="fas fa-question-circle mr-2"></i> 常見問題 Q&A</h3>
    <ul class="list-disc pl-6 space-y-2">
      <li>為何有欄位沒辨識？→ 可能影像不清楚、欄位遮蔽或格式不符，建議重新拍照或人工修正。</li>
      <li>辨識率低怎麼辦？→ 可直接在右側欄位人工修正，儲存後系統會記錄最新內容。</li>
      <li>裁切圖沒顯示？→ 可能原始影像無該欄位，或偵測失敗，請聯絡管理員。</li>
      <li>如何匯出結果？→ 點擊下方「下載 CSV」即可取得本張發票所有欄位資料。</li>
    </ul>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast hidden">儲存成功！</div>

<script>
  // 後端給的原圖資訊（用於 CSV 與 /confirm_result）
  const _fname = "{{ result.filename|default('', true) }}";
  const _img   = "{{ result.imageUrl|default('', true) }}";

  function showToast(msg='儲存成功！'){
    const t=document.getElementById('toast');
    t.textContent=msg; t.classList.remove('hidden');
    setTimeout(()=>t.classList.add('hidden'),3000);
  }

  // 下載 CSV（以畫面值為準）
  document.getElementById('csvBtn').addEventListener('click', ()=>{
    const labels=['發票號碼','統一編號','日期','價格'];
    const keys  =['num','sun','date','cash'];
    const vals  = keys.map(k=>{
      const el = document.querySelector(`input[data-key="${k}"]`);
      return (el? el.value : '').replace(/[\r\n,]/g,' ').trim();
    });
    const rows=[labels, vals];
    const csv = rows.map(r=>r.join(',')).join('\n');
    const blob=new Blob(["\uFEFF"+csv],{type:"text/csv;charset=utf-8;"});
    const base = (_fname || (_img ? _img.split('/').pop() : '') || 'result').replace(/\.[^.]+$/, '');
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download=base+'.csv';
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
  });

  // 單張：直接儲存到資料庫
  document.getElementById('confirmBtn')?.addEventListener('click', async () => {
    try {
      const payload = {
        num:  document.querySelector('input[data-key="num"]')?.value.trim()  || '',
        sun:  document.querySelector('input[data-key="sun"]')?.value.trim()  || '',
        date: document.querySelector('input[data-key="date"]')?.value.trim() || '',
        cash: Number(document.querySelector('input[data-key="cash"]')?.value || 0),
        company_name: (document.querySelector('input[data-key="name"]')?.value.trim() || '未命名')
      };
      const r = await fetch('/confirm_result', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const j = await r.json();
      if (!r.ok || j.ok === false) throw new Error(j.message || '儲存失敗');
      showToast('儲存成功！');
    } catch (e) { alert('儲存失敗：' + e.message); }
  });
</script>
</body>
</html>
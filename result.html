<!DOCTYPE html>
<html lang="zh-TW" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç™¼ç¥¨è©³ç´°è¾¨è­˜çµæœ - fastB2B</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    .toast{position:fixed;bottom:1rem;right:1rem;background:#38a169;color:#fff;padding:.75rem 1.25rem;border-radius:.375rem;box-shadow:0 0 10px rgba(0,0,0,.1);z-index:9999;animation:fadeInOut 3s ease-in-out}
    @keyframes fadeInOut{0%{opacity:0;transform:translateY(10px)}10%,90%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(10px)}}
  </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans transition-colors duration-300">

<div class="flex flex-col min-h-screen">
  <!-- ä¸Šæ–¹å·¥å…·åˆ— -->
  <div class="flex justify-end p-2 gap-2">
    <button onclick="toggleTheme()" class="text-sm bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded shadow">ğŸŒ™ åˆ‡æ›æ·±è‰²æ¨¡å¼</button>
    <a href="{{ url_for('invoice_auto') }}?open=results" class="text-sm bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded shadow">â†© å›åˆ°è¾¨è­˜çµæœ</a>
  </div>

  <!-- ä¸»å…§å®¹ -->
  <div class="flex flex-grow h-[calc(100vh-6rem)]">
    <!-- å·¦ï¼šåŸå§‹åœ–ç‰‡ -->
    <div class="w-1/2 bg-white p-6 overflow-auto flex items-center justify-center">
      <img src="{{ result.imageUrl }}" alt="åŸå§‹ç™¼ç¥¨åœ–ç‰‡"
           class="max-w-full max-h-[85vh] rounded border shadow-lg cursor-zoom-in"
           onclick="toggleImageModal(this.src)" />
    </div>

    <!-- å³ï¼šæ¬„ä½å¡ç‰‡ -->
    <div class="w-1/2 p-6 bg-gray-50 overflow-y-auto">
      {% for item in texts %}
      <div class="flex items-start gap-4 bg-white border rounded-xl shadow hover:shadow-md ring-1 ring-gray-200 p-4 mb-5 transition-transform hover:scale-[1.02]">
        <!-- è£åˆ‡åœ– -->
        <div class="w-36 h-24 border rounded-lg flex items-center justify-center overflow-hidden bg-gray-100">
          {% if item.cropped_image %}
            <img
              src="{{ url_for('yr_uploads_cropped', filename=item.cropped_image) }}"
              alt="{{ item.label }} è£åˆ‡åœ–"
              class="max-w-full max-h-full object-contain cursor-zoom-in"
              onclick="toggleImageModal(this.src)" />
          {% else %}
            <span class="text-gray-400 text-sm">ç„¡åœ–ç‰‡</span>
          {% endif %}
        </div>

        <!-- æ–‡å­—æ¬„ä½ -->
        <div class="flex-1">
          <div class="flex items-center gap-2 text-indigo-700 font-semibold text-base mb-1">
            <i class="fas fa-circle-info"></i>
            <span>{{ item.label }}</span>
          </div>
          <input
            type="text"
            value="{{ item.text }}"
            data-key="{{ item.key }}"
            class="text-sm border rounded-md px-3 py-2 bg-gray-50 w-full focus:outline-none focus:ring-2 focus:ring-indigo-400" />
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- ä¸‹æ–¹æ“ä½œåˆ— -->
  <div class="bg-white border-t p-5 md:p-6 flex justify-center gap-5 md:gap-6 shadow-inner flex-wrap">
    <a href="{{ url_for('invoice_auto') }}?open=results"
       class="inline-flex items-center bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-full shadow text-lg font-medium">
      <i class="fas fa-arrow-left mr-2"></i> è¿”å›è¾¨è­˜çµæœ
    </a>

    <button type="button" onclick="downloadCSV()"
       class="inline-flex items-center bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-full shadow text-lg font-medium">
      <i class="fas fa-file-csv mr-2"></i> ä¸‹è¼‰ CSV
    </button>

    <a href="{{ url_for('home') }}"
       class="inline-flex items-center bg-gray-700 hover:bg-gray-800 text-white px-8 py-3 rounded-full shadow text-lg font-medium">
      <i class="fas fa-home mr-2"></i> å›é¦–é 
    </a>

    <!-- æ–°å¢ï¼šç¢ºèªå„²å­˜ï¼ˆå–®ç­†ï¼‰ -->
    <button id="confirmBtn"
       class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-full shadow text-lg font-medium">
      <i class="fas fa-save mr-2"></i> ç¢ºèªå„²å­˜
    </button>
  </div>
</div>

<!-- åœ–ç‰‡ Modal -->
<div id="imageModal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
  <img id="modalImage" src="" alt="Preview" class="max-h-[90vh] max-w-[90vw] rounded-lg shadow-lg">
</div>

<!-- Toast -->
<div id="toast" class="toast hidden">å„²å­˜æˆåŠŸï¼</div>

<script>
  function toggleImageModal(src){
    const modal=document.getElementById('imageModal');
    const img=document.getElementById('modalImage');
    if(src) img.src=src;
    modal.classList.toggle('hidden');
    modal.classList.toggle('flex');
  }
  document.getElementById('imageModal').addEventListener('click',()=>toggleImageModal());

  function showToast(msg='å„²å­˜æˆåŠŸï¼'){
    const t=document.getElementById('toast');
    t.textContent=msg; t.classList.remove('hidden');
    setTimeout(()=>t.classList.add('hidden'),3000);
  }

  // ä¸‹è¼‰ CSVï¼ˆä»¥ç›®å‰ç•«é¢æ¬„ä½ç‚ºæº–ï¼‰
  function downloadCSV(){
    const labels=['ç™¼ç¥¨è™Ÿç¢¼','çµ±ä¸€ç·¨è™Ÿ','æ—¥æœŸ','åƒ¹æ ¼','è³£æ–¹ç·¨è™Ÿ','å…¬å¸åç¨±','å…¬å¸åœ°å€'];
    const values=Array.from(document.querySelectorAll('input[data-key]'))
      .map(i=>(i.value||'').replace(/[\r\n,]/g,' ').trim());

    const rows=[labels, values];
    const csv=rows.map(r=>r.join(',')).join('\n');
    const blob=new Blob(["\uFEFF"+csv],{type:"text/csv;charset=utf-8;"});

    const _fname = {{ result.filename|default('', true)|tojson }};
    const _img   = {{ result.imageUrl|default('', true)|tojson }};
    const base   = (_fname || (_img ? _img.split('/').pop() : '') || 'result').replace(/\.[^.]+$/, '');

    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download=base+'.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }

  // ç¢ºèªå„²å­˜ï¼ˆæŠŠå–®ç­†é€åˆ° /confirm_resultï¼‰
  document.getElementById('confirmBtn').addEventListener('click', async () => {
    // æŠŠç•«é¢ä¸Šçš„æ¬„ä½çµ„æˆä¸€ç­†
    const get = k => (document.querySelector(`input[data-key="${k}"]`)?.value || '').trim();
    const one = {
      num:  get('num'),
      sun:  get('sun')  || get('snu'),
      data: get('data'),
      cash: get('cash') || get('price'),
      // ç›¸å®¹èˆŠå¾Œç«¯ï¼ˆå¯ä»¥ä¿ç•™ï¼‰
      snu:  get('sun')  || get('snu'),
      price:get('cash') || get('price'),
      bnu:  get('bnu'),
      name: get('name'),
      add:  get('add')
    };

    try{
      const resp = await fetch('/confirm_result',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify([one])      // <== å–®ç­†ä¹Ÿç”¨é™£åˆ—ï¼Œå’Œ auto_inv ä¸€è‡´
      });
      const res = await resp.json();
      if(resp.ok){
        showToast('âœ… è³‡æ–™å·²æˆåŠŸå¯«å…¥è³‡æ–™åº«');
      }else{
        alert('âŒ å„²å­˜å¤±æ•—ï¼š' + (res.error || 'æœªçŸ¥éŒ¯èª¤'));
      }
    }catch(e){
      alert('âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š' + e.message);
    }
  });

  function toggleTheme(){
    const html=document.documentElement;
    const isDark=html.classList.toggle('dark');
    document.body.classList.toggle('bg-gray-900',isDark);
    document.body.classList.toggle('text-white',isDark);
    localStorage.setItem('theme',isDark?'dark':'light');
  }
  window.onload=()=>{ const saved=localStorage.getItem('theme'); if(saved==='dark') toggleTheme(); }
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-TW" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>發票詳細辨識結果 - fastB2B</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    .toast {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      background-color: #38a169;
      color: white;
      padding: 0.75rem 1.25rem;
      border-radius: 0.375rem;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      z-index: 9999;
      animation: fadeInOut 3s ease-in-out;
    }
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateY(10px); }
      10%, 90% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(10px); }
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans transition-colors duration-300">

<div class="flex flex-col min-h-screen">
  <!-- 深色模式切換 -->
  <div class="flex justify-end p-2">
    <button onclick="toggleTheme()" class="text-sm bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded shadow">
      🌙 切換深色模式
    </button>
  </div>

  <!-- 主內容區 -->
  <div class="flex flex-grow h-[calc(100vh-6rem)]">
    <!-- 左側原始圖片 -->
    <div class="w-1/2 bg-white p-6 overflow-auto flex items-center justify-center">
      <img src="{{ result.imageUrl }}" alt="原始發票圖片"
           class="max-w-full max-h-[85vh] rounded border shadow-lg cursor-zoom-in"
           onclick="toggleImageModal(this.src)" />
    </div>

    <!-- 右側辨識結果 -->
    <div class="w-1/2 p-6 bg-gray-50 overflow-y-auto">
      {% for item in texts %}
      <div class="flex items-start gap-4 bg-white border rounded-xl shadow hover:shadow-md ring-1 ring-gray-200 p-4 mb-5 transition-transform hover:scale-[1.02]">
        <!-- 裁切圖 -->
        <div class="w-36 h-24 border rounded-lg flex items-center justify-center overflow-hidden bg-gray-100 cursor-pointer"
             onclick="toggleImageModal(this.querySelector('img')?.src)">
          {% if item.cropped_image %}
            <img src="{{ url_for('uploaded_cropped_file', filename=item.cropped_image.split('/')[-1]) }}"
                 alt="{{ item.label }} 裁切圖" class="max-w-full max-h-full">
          {% else %}
            <span class="text-gray-400">無圖片</span>
          {% endif %}
        </div>
        <!-- 辨識文字欄位 -->
        <div class="flex-1">
          <div class="flex items-center gap-2 text-indigo-700 font-semibold text-base mb-1">
            <i class="fas fa-circle-info"></i>
            <span>{{ item.label }}</span>
          </div>
          <input type="text" value="{{ item.text }}"
                 class="text-sm border rounded-md px-3 py-2 bg-gray-50 w-full focus:outline-none focus:ring-2 focus:ring-indigo-400" />
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- 下方按鈕 -->
  <div class="bg-white border-t p-4 flex justify-center gap-4 shadow-inner flex-wrap">
    <a href="{{ url_for('invoice_auto') }}" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-full shadow text-sm">
      <i class="fas fa-arrow-left mr-1"></i> 返回辨識結果
    </a>
    <a href="/download_result/{{ result.imageUrl.split('/')[-1] }}" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-full shadow text-sm">
      <i class="fas fa-download mr-1"></i> 下載檔案
    </a>
    <a href="{{ url_for('home') }}" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-full shadow text-sm">
      <i class="fas fa-home mr-1"></i> 回首頁
    </a>
    <button onclick="saveData()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-full shadow text-sm">
      <i class="fas fa-save mr-1"></i> 儲存結果
    </button>
  </div>
</div>

<!-- 圖片 Modal 預覽 -->
<div id="imageModal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
  <img id="modalImage" src="" alt="Preview" class="max-h-[90vh] max-w-[90vw] rounded-lg shadow-lg">
</div>

<!-- Toast 通知 -->
<div id="toast" class="toast hidden">儲存成功！</div>

<!-- Script -->
<script>
  function toggleImageModal(src) {
    const modal = document.getElementById('imageModal');
    const img = document.getElementById('modalImage');
    if (src) img.src = src;
    modal.classList.toggle('hidden');
    modal.classList.toggle('flex');
  }

  document.getElementById('imageModal').addEventListener('click', () => {
    toggleImageModal();
  });

  function showToast(message = '儲存成功！') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.remove('hidden');
    setTimeout(() => toast.classList.add('hidden'), 3000);
  }

  async function saveData() {
    const inputs = [...document.querySelectorAll('input')];
    const data = inputs.map(input => input.value);
    try {
      const res = await fetch('/save_result', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      const result = await res.json();
      if (res.ok) {
        showToast('✅ 資料儲存成功');
      } else {
        showToast('❌ 儲存失敗：' + result.error);
      }
    } catch (err) {
      showToast('❌ 發生錯誤：' + err.message);
    }
  }

  function toggleTheme() {
    const html = document.documentElement;
    const isDark = html.classList.toggle('dark');
    document.body.classList.toggle('bg-gray-900', isDark);
    document.body.classList.toggle('text-white', isDark);
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
  }

  window.onload = () => {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') toggleTheme();
  }
</script>

</body>
</html>

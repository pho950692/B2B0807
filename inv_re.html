{% extends "base.html" %}

{% block title %}çµ±è¨ˆå ±è¡¨ - fastB2B{% endblock title %}

{% block head_extra %}
  <!-- Fonts + Chart.js -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --card:#fff; --muted:#6b7280; --ink:#0f172a; --ring:#e5e7eb;
      --brand:#2563eb; --brand-ghost:rgba(37,99,235,.08);
    }
    body{ font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .page-zoom{ font-size: clamp(17px, 1rem + .35vw, 19px); }
    .card{ background:var(--card); border:1px solid var(--ring); border-radius:16px; box-shadow:0 8px 24px rgba(2,6,23,.06); }
    .chip{ display:inline-flex; align-items:center; gap:.55rem; background:var(--brand-ghost); color:var(--brand);
           padding:.42rem .75rem; border-radius:999px; font-size:.95rem; font-weight:700; }
    .h2{ font-size:clamp(2.1rem, 1.6rem + 1.4vw, 2.6rem); font-weight:800; color:var(--ink); }
    .h3{ font-size:1.35rem; font-weight:800; color:var(--ink); }
    .muted{ color:var(--muted); font-size:.98em; }
    .canvas-wrap{ height:380px; } @media (min-width:1280px){ .canvas-wrap{ height:440px; } }
    .ghost-list li{ padding:.45rem 0; } .ghost-list li+li{ border-top:1px dashed var(--ring); }
    select{ font-size:1em; }
    .tip{ font-size:.95em; color:#334155 }
  </style>
{% endblock head_extra %}

{% block content %}
<div class="page-zoom mx-auto max-w-6xl px-4 md:px-6 lg:px-8 py-8">

  <!-- é é¦– -->
  <header class="mb-8">
    <div class="flex flex-wrap items-center gap-3">
      <div class="chip">ğŸ“Š çµ±è¨ˆå ±è¡¨</div>
      {% set total_amt = (vendor_amount_ratio | default([]) | sum(attribute='total')) %}
      <div class="chip">æœŸé–“ç¸½é‡‘é¡ï¼š{{ (total_amt or 0) | round(2) }} å…ƒ</div>
    </div>
    <h2 class="h2 mt-3">ç‡Ÿé‹æ¦‚æ³ Dashboard</h2>
    <p class="muted mt-1">1ï¸âƒ£ ç²’åº¦åˆ‡æ›çš„æŠ˜ç·šåœ–ï¼ˆå¹´ / æœˆ / å¹´æ¯”è¼ƒYTDï¼‰ï½œ2ï¸âƒ£ å„å» å•†å æ¯” ï½œ3ï¸âƒ£ æ•´é«”ç™¼ç¥¨æ•¸é‡è¶¨å‹¢ã€‚</p>
  </header>

  <!-- 1. å¯åˆ‡æ›ç²’åº¦çš„æŠ˜ç·šåœ– -->
  <section class="card p-5 md:p-6 mb-8">
    <div class="flex items-center justify-between mb-4">
      <h3 class="h3">1ï¸âƒ£ ç™¼ç¥¨æ•¸é‡æŠ˜ç·šåœ–</h3>
      <span class="muted">å–®ä½ï¼šç­†</span>
    </div>

    <!-- ç²’åº¦ + å¹´/æœˆ é¸æ“‡ -->
    <div class="grid grid-cols-1 sm:grid-cols-5 gap-4 mb-4">
      <div>
        <label class="block font-semibold mb-1.5">çµ±è¨ˆç²’åº¦</label>
        <select id="selGran" class="w-full border rounded-lg px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500/30">
          <option value="Y">å¹´ï¼ˆé¡¯ç¤ºè©²å¹´ 12 å€‹æœˆï¼‰</option>
          <option value="M">æœˆï¼ˆé¡¯ç¤ºè©²æœˆæ¯æ—¥ï¼‰</option>
          <option value="AY">å¹´æ¯”è¼ƒï¼ˆ2000ï½ä»Šå¹´ï¼Œçµ±è¨ˆåˆ°æœ¬æœˆï¼‰</option>
        </select>
      </div>
      <div class="sm:col-span-2">
        <label class="block font-semibold mb-1.5">å¹´ä»½</label>
        <select id="selYear" class="w-full border rounded-lg px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500/30"></select>
      </div>
      <div class="sm:col-span-2" id="monthWrap">
        <label class="block font-semibold mb-1.5">æœˆä»½</label>
        <select id="selMonth" class="w-full border rounded-lg px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500/30"></select>
      </div>
    </div>
    <p class="tip mb-3">
      å¹´ï¼šè©²å¹´ 12 æœˆ ï½œ æœˆï¼šè©²æœˆæ¯æ—¥ ï½œ å¹´æ¯”è¼ƒï¼š2000ï½ä»Šå¹´ï¼Œæ¯å¹´åªçµ±è¨ˆ 1ï½ç›®å‰æœˆä»½ï¼ˆYTDï¼‰ï¼Œç›´æ¥ç”±ç™¼ç¥¨ç´€éŒ„èšåˆã€‚
    </p>

    <div class="canvas-wrap"><canvas id="smartLineChart"></canvas></div>
  </section>

  <!-- 2. å„å» å•†ç™¼ç¥¨é‡‘é¡å æ¯”ï¼ˆåœ“é¤…åœ–ï¼‰ -->
  <section class="card p-5 md:p-6 mb-8">
    <div class="flex items-center justify-between mb-3">
      <h3 class="h3">2ï¸âƒ£ å„å» å•†ç™¼ç¥¨é‡‘é¡å æ¯”</h3>
      <span class="muted">Top å æ¯”åˆ—è¡¨</span>
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">
      <div class="canvas-wrap"><canvas id="vendorPieChart"></canvas></div>
      <div class="lg:max-w-sm">
        <ul class="ghost-list text-slate-800 leading-relaxed">
          {% for item in vendor_amount_ratio %}
            <li class="flex items-center justify-between">
              <span class="muted">â€¢ {{ item.name or '(æœªå‘½å)' }}</span>
              <span class="font-semibold">{{ item.total | round(2) }} å…ƒ</span>
            </li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </section>

  <!-- 3. ç™¼ç¥¨æ•¸é‡è¶¨å‹¢ï¼ˆå…¨æœŸé–“ï¼‰ -->
  <section class="card p-5 md:p-6">
    <div class="flex items-center justify-between mb-3">
      <h3 class="h3">3ï¸âƒ£ ç™¼ç¥¨æ•¸é‡è¶¨å‹¢ï¼ˆå…¨æœŸé–“ï¼‰</h3>
      <span class="muted">å–®ä½ï¼šç­†</span>
    </div>
    <div class="canvas-wrap"><canvas id="overallTrendChart"></canvas></div>
  </section>

</div>

<script>
  /* ---------- å¾Œç«¯æ³¨å…¥çš„åŸå§‹è³‡æ–™ ---------- */
  const RAW_TREND = {{ (invoice_count_trend | default([])) | tojson }};
  const VENDOR_RATIO = {{ (vendor_amount_ratio | default([])) | tojson }};

  /* ---------- å°å·¥å…· ---------- */
  const pad2 = n => String(n).padStart(2,'0');
  const parseDateOnly = s => (s||'').slice(0,10); // YYYY-MM-DD
  const ymd = (y,m,d)=> `${y}-${pad2(m)}-${pad2(d)}`;
  function daysInMonth(y, m){ return new Date(y, m, 0).getDate(); } // m:1..12
  function firstDayOfYear(y){ return new Date(y,0,1); }

  // ä»¥ã€Œæ—¥ã€ç‚º key çš„ç­†æ•¸ map
  const dayCount = RAW_TREND.reduce((acc, r)=>{
    const k = parseDateOnly(r.date);
    acc[k] = (acc[k]||0) + (Number(r.count)||0);
    return acc;
  }, {});

  // æ‰¾åˆ°æœ€æ–°ä¸€ç­†çš„å¹´æœˆï¼Œçµ¦é è¨­å€¼
  function latestYM(){
    const keys = Object.keys(dayCount).sort();
    if(!keys.length){
      const t = new Date();
      return {y:t.getFullYear(), m:t.getMonth()+1};
    }else{
      const last = keys[keys.length-1];
      return {y:Number(last.slice(0,4)), m:Number(last.slice(5,7))};
    }
  }

  /* ---------- è¡¨å–®å…ƒç´  ---------- */
  const selGran = document.getElementById('selGran');
  const selYear = document.getElementById('selYear');
  const selMonth = document.getElementById('selMonth');
  const monthWrap = document.getElementById('monthWrap');

  // å¹´ï¼š2000 ~ ä»Šå¹´
  function fillYears(){
    const now = new Date().getFullYear();
    for(let y=2000; y<=now; y++){
      selYear.add(new Option(String(y), y));
    }
  }
  // æœˆï¼š1..12
  function fillMonths(){
    selMonth.innerHTML = '';
    for(let m=1; m<=12; m++){
      selMonth.add(new Option(`${m} æœˆ`, m));
    }
  }
  // ç²’åº¦åˆ‡æ›æ™‚ï¼Œåªæœ‰ã€Œæœˆã€éœ€è¦é¡¯ç¤ºæœˆä»½
  function toggleMonth(){
    monthWrap.style.display = (selGran.value === 'M') ? '' : 'none';
  }

  /* ---------- Chart å…±ç”¨æ¨£å¼ ---------- */
  const common = {
    responsive:true, maintainAspectRatio:false,
    plugins:{
      legend:{ position:'bottom', labels:{ usePointStyle:true, boxWidth:10, font:{ size:15, weight:700 } } },
      tooltip:{ backgroundColor:'rgba(15,23,42,.9)', padding:12, titleFont:{ size:15, weight:800 }, bodyFont:{ size:15 } }
    },
    scales:{ x:{ grid:{ display:false }, ticks:{ font:{ size:14 } } },
             y:{ grid:{ color:'#eef2f7' }, ticks:{ font:{ size:14 } } } }
  };

  /* ---------- ç¬¬1å¼µï¼šæ™ºæ…§æŠ˜ç·šåœ– ---------- */
  const smartCtx = document.getElementById('smartLineChart');
  const smartChart = new Chart(smartCtx, {
    type:'line',
    data:{ labels:[], datasets:[{ label:'ç™¼ç¥¨æ•¸é‡', data:[], borderColor:'#2563eb', borderWidth:2.2, pointRadius:2.2, tension:.35, fill:false }]},
    options: common
  });

  // å¹´ç²’åº¦ï¼šè©²å¹´ 12 å€‹æœˆ
  function buildYearSeries(y){
    const labels = Array.from({length:12}, (_,i)=> `${i+1} æœˆ`);
    const data = Array.from({length:12}, (_,i)=>{
      const m = i+1, dmax = daysInMonth(y, m);
      let sum = 0;
      for(let d=1; d<=dmax; d++){
        sum += (dayCount[ymd(y,m,d)] || 0);
      }
      return sum;
    });
    return {labels, data};
  }
  // æœˆç²’åº¦ï¼šè©²æœˆæ¯æ—¥
  function buildMonthSeries(y, m){
    const dmax = daysInMonth(y, m);
    const labels = Array.from({length:dmax}, (_,i)=> i+1);
    const data = labels.map(d => dayCount[ymd(y,m,d)] || 0);
    return {labels, data};
  }
  // å¹´æ¯”è¼ƒï¼ˆYTDï¼‰ï¼š2000ï½ä»Šå¹´ï¼Œæ¯å¹´åªç´¯è¨ˆ 1ï½ç›®å‰æœˆä»½
  function buildAnnualYTDSeries(){
    const now = new Date();
    const nowY = now.getFullYear();
    const nowM = now.getMonth()+1;
    const startY = 2000;

    const labels = [];
    const data = [];
    const slots = Array(nowY - startY + 1).fill(0);

    // ç›´æ¥æ ¹æ“šæ—¥ç´€éŒ„ç´¯è¨ˆï¼šåªç®—æœˆä»½ <= ç¾åœ¨æœˆä»½
    Object.keys(dayCount).forEach(k=>{
      const y = +k.slice(0,4);
      const m = +k.slice(5,7);
      if(y >= startY && y <= nowY && m <= nowM){
        slots[y - startY] += dayCount[k];
      }
    });

    for(let y=startY; y<=nowY; y++){
      labels.push(String(y));
      data.push(slots[y - startY] || 0);
    }
    return {labels, data};
  }

  function refreshSmartChart(){
    const y = Number(selYear.value);
    const gran = selGran.value;
    let series;
    if(gran === 'Y'){
      series = buildYearSeries(y);
    }else if(gran === 'M'){
      const m = Number(selMonth.value);
      series = buildMonthSeries(y, m);
    }else{ // 'AY' å¹´æ¯”è¼ƒYTD
      series = buildAnnualYTDSeries();
    }
    smartChart.data.labels = series.labels;
    smartChart.data.datasets[0].data = series.data;
    smartChart.update();
  }

  /* ---------- ç¬¬2å¼µï¼šå„å» å•†å æ¯” ---------- */
  const pieCtx = document.getElementById('vendorPieChart');
  new Chart(pieCtx, {
    type:'pie',
    data:{
      labels: VENDOR_RATIO.map(v => v.name || '(æœªå‘½å)'),
      datasets:[{
        data: VENDOR_RATIO.map(v => v.total || 0),
        backgroundColor:['#60a5fa','#34d399','#f87171','#fbbf24','#a78bfa','#fb7185','#4ade80','#22d3ee']
      }]
    },
    options:{ ...common, scales: undefined }
  });

  /* ---------- ç¬¬3å¼µï¼šå…¨æœŸé–“è¶¨å‹¢ ---------- */
  const trendLabels = RAW_TREND.map(r => parseDateOnly(r.date));
  const trendData = RAW_TREND.map(r => Number(r.count)||0);
  const trendCtx = document.getElementById('overallTrendChart');
  new Chart(trendCtx, {
    type:'line',
    data:{ labels:trendLabels, datasets:[{ label:'ç™¼ç¥¨æ•¸é‡', data:trendData, borderColor:'#10b981', borderWidth:2.2, pointRadius:2.2, tension:.35, fill:false }]},
    options: common
  });

  /* ---------- åˆå§‹åŒ– ---------- */
  (function init(){
    fillYears();
    fillMonths();
    const {y, m} = latestYM();
    selYear.value = y;
    selMonth.value = m;
    toggleMonth();
    refreshSmartChart();

    selGran.addEventListener('change', ()=>{ toggleMonth(); refreshSmartChart(); });
    selYear.addEventListener('change', refreshSmartChart);
    selMonth.addEventListener('change', refreshSmartChart);
  })();
</script>
{% endblock content %}

{% extends "base.html" %}

{% block title %}辨識發票 - fastB2B{% endblock %}

{% block head_extra %}
  {% if 'user_id' not in session %}
    <script>alert('⚠️ 提醒：你尚未登入，辨識結果不會儲存到系統');</script>
  {% endif %}
{% endblock %}

{% block content %}

<div class="max-w-7xl mx-auto bg-white rounded-xl shadow-md p-8 mt-10 animate__animated animate__fadeIn text-base md:text-lg">
  <h2 class="text-3xl font-bold text-blue-700 mb-6 flex items-center">
    <i class="fas fa-file-invoice mr-3"></i> 自動辨識發票
  </h2>
  <p class="text-sm text-gray-500 mb-6">支援 JPG / PNG / PDF，多檔拖曳上傳，自動裁切與文字辨識。</p>

  <div class="mb-6 flex flex-wrap gap-4 items-center">
    <!-- input 1：選取單一或多個圖片/PDF 檔案 -->
    <input type="file" id="filePicker" class="hidden" multiple accept=".jpg,.jpeg,.png,.pdf,image/*" />
    <!-- input 2：選取整個資料夾 -->
    <input type="file" id="folderPicker" class="hidden" webkitdirectory directory accept=".jpg,.jpeg,.png,.pdf,image/*" />

    <!-- 操作按鈕 -->
    <button id="btnPickFiles" onclick="document.getElementById('filePicker').click()" class="bg-gray-200 hover:bg-gray-300 text-sm px-4 py-2 rounded">
      <i class="fas fa-upload mr-1"></i> 選擇檔案
    </button>
    <button id="btnPickFolder" onclick="document.getElementById('folderPicker').click()" class="bg-gray-200 hover:bg-gray-300 text-sm px-4 py-2 rounded">
      <i class="fas fa-folder-open mr-1"></i> 選擇資料夾
    </button>

    <a href="/camera" class="bg-green-600 hover:bg-green-700 text-white text-sm px-4 py-2 rounded inline-flex items-center">
      <i class="fas fa-camera mr-1"></i> 開啟鏡頭
    </a>
  </div>

  <div class="overflow-x-auto">
    <table class="w-full border border-gray-300 text-center text-base" id="fileTable">
      <thead class="bg-gray-100">
        <tr>
          <th class="border px-4 py-2">檔案名稱</th>
          <th class="border px-4 py-2">日期</th>
          <th class="border px-4 py-2">操作</th>
          <th class="border px-4 py-2">預覽</th>
        </tr>
      </thead>
      <tbody id="fileTableBody"></tbody>
    </table>
  </div>

  <div class="mt-6 flex justify-end gap-4">
    <a href="/" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded text-base">回首頁</a>
    <button id="btnClearAll" onclick="clearAllFiles()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded text-base">全部清除</button>
    <button id="btnStart" onclick="submitFiles()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded text-base font-semibold">開始辨識</button>
  </div>

  <!-- 進度條區塊 -->
  <div class="mt-4 p-3 border rounded bg-gray-50">
    <div class="w-full bg-gray-200 rounded h-3 overflow-hidden">
      <div id="progressBar" class="bg-blue-600 h-3 transition-all duration-300" style="width:0%"></div>
    </div>
    <div class="mt-2 text-sm text-gray-700 flex items-center gap-3">
      <span id="progressStatus">等待開始…</span>
      <span id="progressCounter" class="px-2 py-0.5 rounded bg-blue-100 text-blue-700">0 / 0</span>
      <span id="progressPercent" class="px-2 py-0.5 rounded bg-gray-100 text-gray-700">0%</span>
    </div>
  </div>

  <div id="pagination" class="mt-4 flex justify-center space-x-2"></div>
</div>

<!-- 辨識結果彈窗 -->
<div id="resultModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-lg shadow-xl w-[95%] max-w-[95%] max-h-[90vh] p-6 overflow-x-auto overflow-y-auto relative">
    <h2 class="text-3xl font-bold mb-4"><i class="fas fa-edit mr-2"></i> 辨識結果編輯</h2>
    <table class="w-full border border-gray-300 text-center text-base min-w-max">
      <thead class="bg-gray-100">
        <tr>
          <th class="border px-4 py-2">圖片檔名</th>
          <th class="border px-4 py-2">發票號碼</th>
          <th class="border px-4 py-2">統一編號</th>
          <th class="border px-4 py-2">日期</th>
          <th class="border px-4 py-2">價格</th>
          <th class="border px-4 py-2">賣方編號</th>
          <th class="border px-4 py-2">公司名稱</th>
          <th class="border px-4 py-2">公司地址</th>
          <th class="border px-4 py-2">預覽</th>
        </tr>
      </thead>
      <tbody id="modalResultsBody"></tbody>
    </table>
    <div class="mt-6 flex justify-end space-x-3">
      <button id="reRecognizeBtn" class="bg-gray-300 hover:bg-gray-400 px-5 py-2 rounded text-base">重新辨識</button>
      <button id="downloadBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-5 py-2 rounded text-base">下載 CSV</button>
      <button id="confirmBtn" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded text-base">確認儲存</button>
      <button id="closeModalBtn" class="absolute top-4 right-4 text-3xl text-gray-600 hover:text-gray-900">&times;</button>
    </div>
  </div>
</div>

<!-- 圖片預覽 -->
<div id="imagePreviewModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white p-4 rounded shadow-lg relative max-w-4xl w-full">
    <button onclick="closeImagePreview()" class="absolute top-2 right-3 text-3xl font-bold text-gray-600 hover:text-black">&times;</button>
    <img id="previewImage" src="" alt="預覽圖片" class="mx-auto max-h-[80vh] object-contain" />
  </div>
</div>

<script>
  /* ===================== 清洗工具 ===================== */
  function keepAlnum(s){ return String(s||'').replace(/[^A-Za-z0-9]/g,''); }      // 發票號碼：英數
  function keepDigits(s){ return String(s||'').replace(/\D/g,''); }               // 統編、賣方編號：數字
  function keepNumber(s){                                                         // 價格：數字+唯一小數點
    let t = String(s||'').replace(/[^0-9.]/g,'');
    const i = t.indexOf('.');
    if (i !== -1) t = t.slice(0,i+1) + t.slice(i+1).replace(/\./g,'');
    return t;
  }
  function sanitizeRow(row){
    return {
      ...row,
      num:  keepAlnum(row?.num).slice(0,14),
      snu:  keepDigits(row?.snu).slice(0,8),
      bnu:  keepDigits(row?.bnu).slice(0,8),
      price: keepNumber(row?.price),
      // data / name / add 原樣
    };
  }

  /* ===================== 狀態元素 ===================== */
  const fileTableBody    = document.getElementById('fileTableBody');
  const modalResultsBody = document.getElementById('modalResultsBody');
  const resultModal      = document.getElementById('resultModal');

  const btnPickFiles  = document.getElementById('btnPickFiles');
  const btnPickFolder = document.getElementById('btnPickFolder');
  const btnClearAll   = document.getElementById('btnClearAll');
  const btnStart      = document.getElementById('btnStart');

  const progressBar     = document.getElementById('progressBar');
  const progressStatus  = document.getElementById('progressStatus');
  const progressCounter = document.getElementById('progressCounter');
  const progressPercent = document.getElementById('progressPercent');

  let selectedFiles = [];
  let recognizedResults = [];
  try { recognizedResults = JSON.parse(localStorage.getItem('recognizedResults') || '[]'); } catch { recognizedResults = []; }

  /* ===================== 進度條 / 輪詢 ===================== */
  let pollTimer = null;
  function setProgress(done, total, finished, error) {
    const percent = (!total || total === 0) ? 0 : Math.floor(done * 100 / total);
    progressBar.style.width = percent + '%';
    progressCounter.textContent = `${done} / ${total}`;
    progressPercent.textContent = percent + '%';
    if (error) {
      progressStatus.textContent = `處理完成（有錯誤）：${error}`;
    } else if (finished) {
      progressStatus.textContent = '處理完成 ✅';
    } else if (total > 0) {
      progressStatus.textContent = '辨識中…';
    } else {
      progressStatus.textContent = '開始辨識中…';
    }
  }
  function disableActions(disabled) {
    [btnPickFiles, btnPickFolder, btnClearAll, btnStart].forEach(b => b.disabled = !!disabled);
    [btnPickFiles, btnPickFolder, btnClearAll, btnStart].forEach(b => {
      b.classList.toggle('opacity-50', !!disabled);
      b.classList.toggle('cursor-not-allowed', !!disabled);
    });
  }
  function startProgressPolling(jobId) {
    // 先歸零，等待後端第一次回報 total
    setProgress(0, 0, false, '');
    if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
    pollTimer = setInterval(async () => {
      try {
        const r = await fetch(`/progress/${jobId}`, { cache: 'no-store' });
        if (!r.ok) return;
        const p = await r.json();
        setProgress(p.done || 0, p.total || 0, !!p.finished, p.error || '');
        if (p.finished) {
          clearInterval(pollTimer); pollTimer = null;
          disableActions(false);
        }
      } catch (e) {}
    }, 500);
  }

  /* ===================== 檔案清單（含分頁） ===================== */
  let currentPage = 1;
  const rowsPerPage = 10;

  function renderFileTable() {
    fileTableBody.innerHTML = '';
    const today = new Date().toISOString().split('T')[0];

    const start = (currentPage - 1) * rowsPerPage;
    const end   = start + rowsPerPage;
    const pageFiles = selectedFiles.slice(start, end);

    pageFiles.forEach((file, idx) => {
      fileTableBody.innerHTML += `
        <tr>
          <td class="border px-4 py-2">${file.name}</td>
          <td class="border px-4 py-2">${today}</td>
          <td class="border px-4 py-2 space-x-2">
            <label class="bg-yellow-400 hover:bg-yellow-500 text-white text-sm px-2 py-1 rounded cursor-pointer">
              修改<input type="file" accept="image/*" class="hidden" onchange="replaceFile(event, ${start + idx})" />
            </label>
            <button onclick="removeFile(${start + idx})" class="bg-red-400 hover:bg-red-500 text-white text-sm px-2 py-1 rounded">刪除</button>
          </td>
          <td class="border px-4 py-2">
            <button onclick="previewFile(${start + idx})" class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-3 py-1 rounded">預覽</button>
          </td>
        </tr>`;
    });
    renderPagination();
  }
  function renderPagination() {
    const pageCount = Math.ceil(selectedFiles.length / rowsPerPage);
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';
    for (let i = 1; i <= pageCount; i++) {
      pagination.innerHTML += `
        <button onclick="changePage(${i})" class="${i === currentPage ? 'bg-blue-600 text-white' : 'bg-gray-200'} px-3 py-1 rounded">
          ${i}
        </button>`;
    }
  }
  function changePage(p) { currentPage = p; renderFileTable(); }
  function replaceFile(e, idx) { if (e.target.files[0]) { selectedFiles[idx] = e.target.files[0]; renderFileTable(); } }
  function removeFile(idx) {
    selectedFiles.splice(idx, 1);
    const maxPage = Math.max(1, Math.ceil(selectedFiles.length / rowsPerPage));
    if (currentPage > maxPage) currentPage = maxPage;
    renderFileTable();
  }
  function handleFiles(fileList) { selectedFiles = selectedFiles.concat(Array.from(fileList)); renderFileTable(); }
  document.getElementById('filePicker').onchange  = function () { handleFiles(this.files); };
  document.getElementById('folderPicker').onchange = function () { handleFiles(this.files); };

  function clearAllFiles() {
    selectedFiles = [];
    recognizedResults = [];
    document.getElementById('filePicker').value = '';
    document.getElementById('folderPicker').value = '';
    currentPage = 1;
    renderFileTable();
    closeModal();
    setProgress(0, 0, false, '');
    try { localStorage.removeItem('recognizedResults'); } catch {}
  }

  /* ===================== 上傳並辨識 ===================== */
  async function submitFiles() {
    if (selectedFiles.length === 0) {
      alert('請先選擇檔案');
      return;
    }

    disableActions(true);
    const formData = new FormData();
    selectedFiles.forEach((file) => formData.append('files', file));

    const jobId = crypto.randomUUID();
    formData.append('job_id', jobId);
    startProgressPolling(jobId);

    try {
      const response = await fetch('/upload', { method: 'POST', body: formData });
      const payload = await response.json().catch(() => ({}));

      if (!response.ok) {
        setProgress(0, selectedFiles.length || 0, true, payload.error || response.statusText);
        disableActions(false);
        alert('上傳失敗: ' + (payload.error || response.statusText));
        return;
      }

      let results = payload.results || payload;
      if (!Array.isArray(results) || results.length === 0) {
        setProgress(selectedFiles.length || 0, selectedFiles.length || 0, true, '');
        disableActions(false);
        alert('沒有辨識結果');
        return;
      }

      // 前端先淨化，確保畫面乾淨
      recognizedResults = results.map(sanitizeRow);
      try { localStorage.setItem('recognizedResults', JSON.stringify(recognizedResults)); } catch {}

      showRecognizeResults(recognizedResults);

      // 補滿進度
      setProgress(selectedFiles.length || recognizedResults.length, selectedFiles.length || recognizedResults.length, true, '');
      disableActions(false);
    } catch (err) {
      setProgress(0, selectedFiles.length || 0, true, err.message || '未知錯誤');
      disableActions(false);
      alert('發生錯誤: ' + err.message);
    }
  }

  /* ===================== 顯示結果（DOM API） ===================== */
  function showRecognizeResults(results) {
    const tbody = document.getElementById('modalResultsBody');
    if (!tbody) return;
    tbody.innerHTML = '';

    (results || []).forEach((r, idx) => {
      const filename = r.filename || (r.imageUrl ? r.imageUrl.split('/').pop() : `image_${idx+1}.jpg`);
      const tr = document.createElement('tr');

      const tdText = (text) => {
        const td = document.createElement('td');
        td.className = 'border px-4 py-2';
        td.textContent = text ?? '';
        return td;
      };
      const tdInput = (key) => {
        const td = document.createElement('td');
        td.className = 'border px-4 py-2';
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'w-full text-center';
        input.value = r[key] ?? '';

        // 即時清洗
        input.oninput = () => {
          let v = input.value;
          if (key === 'num')  v = keepAlnum(v).slice(0,14);
          if (key === 'snu')  v = keepDigits(v).slice(0,8);
          if (key === 'bnu')  v = keepDigits(v).slice(0,8);
          if (key === 'price') v = keepNumber(v);
          input.value = v;
        };
        // 失焦再保險一次
        input.onchange = () => {
          let v = input.value;
          if (key === 'num')  v = keepAlnum(v).slice(0,14);
          if (key === 'snu')  v = keepDigits(v).slice(0,8);
          if (key === 'bnu')  v = keepDigits(v).slice(0,8);
          if (key === 'price') v = keepNumber(v);
          recognizedResults[idx][key] = v;
          input.value = v;
          cacheResults();
        };

        td.appendChild(input);
        return td;
      };

      tr.appendChild(tdText(filename));
      tr.appendChild(tdInput('num'));
      tr.appendChild(tdInput('snu'));
      tr.appendChild(tdInput('data'));
      tr.appendChild(tdInput('price'));
      tr.appendChild(tdInput('bnu'));
      tr.appendChild(tdInput('name'));
      tr.appendChild(tdInput('add'));

      const tdPreview = document.createElement('td');
      tdPreview.className = 'border px-4 py-2';
      const a = document.createElement('a');
      a.href = `/result/${filename}`;
      a.target = '_blank';
      a.className = 'bg-purple-600 hover:bg-purple-700 text-white text-sm px-2 py-1 rounded';
      a.textContent = '詳細預覽';
      tdPreview.appendChild(a);
      tr.appendChild(tdPreview);

      tbody.appendChild(tr);
    });

    document.getElementById('resultModal').classList.remove('hidden');
  }

  function cacheResults() {
    try { localStorage.setItem('recognizedResults', JSON.stringify(recognizedResults)); } catch {}
  }

  function closeModal() { resultModal.classList.add('hidden'); }
  document.getElementById('closeModalBtn').onclick = closeModal;

  // 重新辨識：有檔案就直接再送一次
  document.getElementById('reRecognizeBtn').onclick = () => {
    if (!selectedFiles.length) { alert('沒有可重新辨識的檔案'); return; }
    submitFiles();
  };

  /* ===================== 下載 CSV ===================== */
  document.getElementById('downloadBtn').onclick = () => {
    if (!recognizedResults || !recognizedResults.length) { alert('無辨識結果可下載'); return; }
    const rows = [['發票號碼','統一編號','日期','價格','賣方編號','公司名稱','公司地址']];
    recognizedResults.forEach(r => rows.push([r.num||'', r.snu||'', r.data||'', r.price||'', r.bnu||'', r.name||'', r.add||'']));
    const csv = rows.map(r => r.join(',')).join('\n');
    const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = '辨識結果.csv';
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
  };

  /* ===================== 確認儲存 ===================== */
  document.getElementById('confirmBtn').onclick = async () => {
    const isLoggedIn = {{ 'true' if 'user_id' in session else 'false' }};
    if (!isLoggedIn) { alert('⚠️ 請先登入，才可儲存資料'); return; }

    // 最後一層防呆
    recognizedResults = (recognizedResults || []).map(sanitizeRow);

    try {
      const response = await fetch('/confirm_result', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(recognizedResults || [])
      });
      const res = await response.json();
      if (response.ok) {
        alert('✅ 資料已成功寫入資料庫');
        closeModal();
        try { localStorage.removeItem('recognizedResults'); } catch {}
      } else {
        alert('❌ 儲存失敗：' + res.error);
      }
    } catch (err) {
      alert('❌ 發生錯誤：' + err.message);
    }
  };

  /* ===================== 圖片預覽 ===================== */
  function previewFile(idx){
    const src = URL.createObjectURL(selectedFiles[idx]);
    if (!src) return alert('找不到圖片或路徑錯誤');
    const modal = document.getElementById("imagePreviewModal");
    const img   = document.getElementById("previewImage");
    img.src = src; modal.classList.remove("hidden");
  }
  function closeImagePreview() {
    const modal = document.getElementById("imagePreviewModal");
    const img   = document.getElementById("previewImage");
    img.src = ""; modal.classList.add("hidden");
  }

  /* ===================== 自動還原快取（open=results） ===================== */
  (function () {
    const params = new URLSearchParams(window.location.search);
    if (params.get('open') !== 'results') return;
    let cached = [];
    try { cached = JSON.parse(localStorage.getItem('recognizedResults') || '[]'); } catch {}
    if (Array.isArray(cached) && cached.length > 0) {
      recognizedResults = cached.map(sanitizeRow);
      showRecognizeResults(recognizedResults);
    }
  })();
</script>

{% endblock %}
